@model Inventory.Application.DTOs.Reporting.DashboardResponseDto
@{
    ViewData["Title"] = "Dashboard";
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <h1 class="display-3 fw-black text-uppercase mb-0">Inventory Dashboard</h1>
    </div>

    <!-- Top metric cards -->
    <div class="row g-4 mb-5">
        <div class="col-12 col-md-6 col-lg-3">
            <div class="neo-metric bg-neo-info">
                <div class="neo-metric-label">Total Products</div>
                <div class="neo-metric-value" id="metric-total-products">@Model.TotalProducts</div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="neo-metric bg-neo-success">
                <div class="neo-metric-label">Sales Orders</div>
                <div class="neo-metric-value" id="metric-total-sales-orders">-</div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="neo-metric bg-neo-danger">
                <div class="neo-metric-label">Low Stock</div>
                <div class="neo-metric-value" id="metric-low-stock">@Model.LowStockCount</div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="neo-metric bg-neo-warning">
                <div class="neo-metric-label">Purchase Orders</div>
                <div class="neo-metric-value" id="metric-total-purchase-orders">-</div>
            </div>
        </div>
    </div>

    <!-- Stock Operations Section -->
    <div class="neo-card mb-5 bg-black text-white p-5">
        <h4 class="mb-4 fw-black text-uppercase">Stock Operations</h4>
        <div class="row g-3">
            <div class="col-3">
                <button type="button" class="neo-btn neo-btn-primary w-100" id="btn-sales-order-shortcut">
                    <i class="bi bi-cart-plus"></i> SALES ORDER
                </button>
            </div>
            <div class="col-3">
                <button type="button" class="neo-btn neo-btn-success w-100" id="btn-receive-stock">
                    <i class="bi bi-box-arrow-in-down"></i> RECEIVE
                </button>
            </div>
            <div class="col-3">
                <a asp-controller="Inventory" asp-action="Issue" class="neo-btn neo-btn-warning w-100" id="btn-issue-stock">
                    <i class="bi bi-box-arrow-up"></i> ISSUE
                </a>
            </div>
            <div class="col-3">
                <a asp-controller="Inventory" asp-action="Adjust" class="neo-btn neo-btn-info w-100" id="btn-adjust-stock">
                    <i class="bi bi-sliders"></i> ADJUST
                </a>
            </div>
        </div>
    </div>

    <!-- Products & Stock Levels Table -->
    <div class="neo-card p-0 overflow-hidden">
        <div class="p-4 bg-black text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-black text-uppercase">Products & Stock Levels</h5>
            <button type="button" class="neo-btn neo-btn-primary btn-sm" id="btn-add-product">
                <i class="bi bi-plus-circle"></i> ADD PRODUCT
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="products-stock-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>SKU</th>
                        <th class="text-end">Safe Stock</th>
                        <th class="text-end">On Hand</th>
                        <th class="text-end">Reserved</th>
                        <th class="text-end">Available</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            LOADING PRODUCTS...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODALS - Systemic preservation of forms and IDs -->

<!-- Receive Stock Modal (Simplified Single-Page + Multi-Product) -->
<div class="modal fade" id="receiveStockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-neo-success">
                <h5 class="modal-title fw-black text-uppercase">Receive Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="receiveStockForm">
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label for="receiveSupplierId" class="form-label fw-black text-uppercase small">Supplier</label>
                            <select id="receiveSupplierId" name="SupplierId" class="form-select border-2 border-black" required>
                                <option value="">-- LOADING SUPPLIERS --</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="receiveDueDate" class="form-label fw-black text-uppercase small">Payment Deadline</label>
                            <input type="date" id="receiveDueDate" name="DueDate" class="form-control border-2 border-black" value="@DateTime.Today.AddDays(14).ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-md-5">
                            <label for="receiveNote" class="form-label fw-black text-uppercase small">Notes</label>
                            <input type="text" id="receiveNote" name="Note" class="form-control border-2 border-black" placeholder="Order remarks...">
                        </div>
                    </div>

                    <!-- Line Items Table -->
                    <div class="table-responsive mb-4">
                        <table class="table table-bordered border-black align-middle" id="receiveLinesTable">
                            <thead class="table-dark text-uppercase small">
                                <tr>
                                    <th style="width: 35%;">Product</th>
                                    <th style="width: 15%;">Quantity</th>
                                    <th style="width: 20%;">Batch Number</th>
                                    <th style="width: 20%;">Unit Cost (Base)</th>
                                    <th style="width: 10%;" class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows will be added dynamically -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5">
                                        <button type="button" class="neo-btn neo-btn-sm neo-btn-primary" id="btn-add-line">
                                            <i class="bi bi-plus-circle me-1"></i> ADD PRODUCT
                                        </button>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="row g-4 align-items-end">
                        <!-- Tax & Expenses Controls -->
                        <div class="col-md-6">
                            <div class="neo-card bg-light p-3 border-2 border-black">
                                <h6 class="fw-black text-uppercase small mb-3">Global Configuration</h6>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="receiveApplyVat" name="ApplyVat" checked>
                                            <label class="form-check-label small fw-bold" for="receiveApplyVat">Apply VAT (14%)</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="receiveApplyManTax" name="ApplyManufacturingTax" checked>
                                            <label class="form-check-label small fw-bold" for="receiveApplyManTax">Apply Man. Tax (1%)</label>
                                        </div>
                                    </div>
                                    <div class="col-12 mt-3">
                                        <label for="receiveExpenses" class="form-label fw-black text-uppercase small mb-1">Total Receipt Expenses</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-black text-white">$</span>
                                            <input type="number" id="receiveExpenses" name="ReceiptExpenses" class="form-control border-black" step="0.01" min="0" value="0" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Summary -->
                        <div class="col-md-6">
                            <div class="neo-card p-4 border-3 border-black bg-black text-white rounded-0">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-uppercase small opacity-75">Subtotal:</span>
                                    <span id="summary-subtotal" class="fw-bold">$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-uppercase small opacity-75">VAT (14%):</span>
                                    <span id="summary-vat" class="fw-bold">$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-uppercase small opacity-75">Man. Tax (1%):</span>
                                    <span id="summary-mantax" class="fw-bold text-danger">-$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-uppercase small opacity-75">Expenses:</span>
                                    <span id="summary-expenses" class="fw-bold">$0.00</span>
                                </div>
                                <hr class="border-white opacity-25">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="h5 fw-black text-uppercase mb-0">Total Due:</span>
                                    <span id="summary-total" class="h4 fw-black text-success mb-0">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="neo-btn" data-bs-dismiss="modal">CANCEL</button>
                <button type="button" class="neo-btn neo-btn-success shadow-sm" id="btn-receive-submit">
                    <i class="bi bi-check2-circle me-1"></i> COMPLETE RECEIPT
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Issue Stock Modal -->
<div class="modal fade" id="issueStockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-neo-warning">
                <h5 class="modal-title fw-black text-uppercase">Issue Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="issueStockForm" action="/Inventory/Issue" method="post">
                <div class="modal-body p-4">
                    @Html.AntiForgeryToken()
                    <div class="mb-4">
                        <label for="issueProductId" class="form-label fw-black text-uppercase small">Select Product</label>
                        <select id="issueProductId" name="ProductId" class="form-select" required>
                            <option value="">-- LOADING --</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="issueQuantity" class="form-label fw-black text-uppercase small">Quantity to Issue</label>
                        <input type="number" id="issueQuantity" name="Quantity" class="form-control" step="0.01" min="0.01" required />
                    </div>
                    <div class="mb-4">
                        <label for="issueBatchNumber" class="form-label fw-black text-uppercase small">Batch Number</label>
                        <input type="text" id="issueBatchNumber" name="BatchNumber" class="form-control" placeholder="e.g. BATCH-2026-001" />
                    </div>
                    <div class="mb-0">
                        <label for="issueNote" class="form-label fw-black text-uppercase small">Notes</label>
                        <textarea id="issueNote" name="Note" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="neo-btn" data-bs-dismiss="modal">CANCEL</button>
                    <button type="submit" class="neo-btn neo-btn-warning">COMPLETE ISSUANCE</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Adjust Stock Modal -->
<div class="modal fade" id="adjustStockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-neo-info">
                <h5 class="modal-title fw-black text-uppercase">Adjust Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="adjustStockForm" action="/Inventory/Adjust" method="post">
                <div class="modal-body p-4">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="RowVersion" id="adjustRowVersion" />
                    <div class="mb-4">
                        <label for="adjustProductId" class="form-label fw-black text-uppercase small">Select Product</label>
                        <select id="adjustProductId" name="ProductId" class="form-select" required>
                            <option value="">-- LOADING --</option>
                        </select>
                    </div>
                    <div class="mb-0">
                        <label for="adjustQuantity" class="form-label fw-black text-uppercase small">New On-Hand Quantity</label>
                        <input type="number" id="adjustQuantity" name="NewQuantity" class="form-control" step="0.01" min="0" required />
                        <div class="mt-2 fw-bold text-danger">⚠️ DIRECT OVERWRITE WARNING</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="neo-btn" data-bs-dismiss="modal">CANCEL</button>
                    <button type="submit" class="neo-btn neo-btn-info">UPDATE STOCK</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-black text-uppercase">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addProductForm" action="/Products/Create" method="post">
                <div class="modal-body p-4">
                    @Html.AntiForgeryToken()
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label for="addName" class="form-label fw-black text-uppercase small">Product Name</label>
                            <input type="text" id="addName" name="Name" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label for="addSku" class="form-label fw-black text-uppercase small">SKU</label>
                            <input type="text" id="addSku" name="Sku" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label for="addUnit" class="form-label fw-black text-uppercase small">Unit</label>
                            <input type="text" id="addUnit" name="Unit" class="form-control" required />
                        </div>

                        <div class="col-md-6">
                            <label for="addReorderPoint" class="form-label fw-black text-uppercase small">Reorder Point</label>
                            <input type="number" id="addReorderPoint" name="ReorderPoint" class="form-control" step="0.01" min="0" required />
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="form-check pb-2">
                                <input class="form-check-input" type="checkbox" name="IsActive" id="addIsActive" value="true" checked>
                                <label class="form-check-label" for="addIsActive">Product is Active</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="neo-btn" data-bs-dismiss="modal">CANCEL</button>
                    <button type="submit" class="neo-btn neo-btn-primary">SAVE PRODUCT</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Batch Edit Modal -->
<div class="modal fade" id="batchEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-black text-uppercase" id="batchEditTitle">Edit Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="batchEditProductId" />
                <input type="hidden" id="batchEditBatchNumber" />
                <input type="hidden" id="batchEditRowVersion" />

                <div class="row g-4">
                    <div class="col-6">
                        <label class="form-label fw-black text-uppercase small" for="batchEditUnitCost">Cost</label>
                        <input class="form-control" id="batchEditUnitCost" type="number" step="0.01" min="0" />
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-black text-uppercase small" for="batchEditUnitPrice">Price</label>
                        <input class="form-control" id="batchEditUnitPrice" type="number" step="0.01" min="0" />
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-black text-uppercase small" for="batchEditNotes">Notes</label>
                        <textarea class="form-control" id="batchEditNotes" rows="3" maxlength="500"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="neo-btn" data-bs-dismiss="modal">CANCEL</button>
                <button type="button" class="neo-btn neo-btn-primary" id="batchEditSave">SAVE CHANGES</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const pendingRequests = new Map();

            function refreshDashboard() {
                fetch('@Url.Action("SummaryJson", "Dashboard")')
                    .then(r => r.ok ? r.json() : Promise.reject())
                    .then(data => {
                        document.getElementById('metric-total-products').textContent = data.totalProducts || 0;
                        document.getElementById('metric-total-sales-orders').textContent = data.totalSalesOrders || 0;
                        document.getElementById('metric-low-stock').textContent = data.lowStockCount || 0;
                        document.getElementById('metric-total-purchase-orders').textContent = data.totalPurchaseOrders || 0;
                    });
                loadProducts();
            }
            window.refreshDashboard = refreshDashboard;

            let allProductsForModals = [];

            function loadProducts() {
                const tbody = document.querySelector('#products-stock-table tbody');
                fetch('/api/products/with-stock')
                    .then(r => r.ok ? r.json() : Promise.reject())
                    .then(items => {
                        allProductsForModals = items;
                        updateProductDropdowns(items);

                        if (!Array.isArray(items) || items.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-5">NO PRODUCTS FOUND. <button class="neo-btn neo-btn-primary ms-3" data-bs-toggle="modal" data-bs-target="#addProductModal">ADD FIRST PRODUCT</button></td></tr>';
                            return;
                        }
                        tbody.innerHTML = items.map(x => {
                            const status = x.status || 'InStock';
                            let badgeClass = 'neo-btn-success';
                            if(status === 'NoStock') badgeClass = 'neo-btn-danger';
                            if(status === 'LowStock') badgeClass = 'neo-btn-warning';
                            
                            const statusText = status === 'NoStock' ? 'NO STOCK' : (status === 'LowStock' ? 'LOW STOCK' : 'IN STOCK');
                            
                            return `<tr>
                                <td>
                                    <button type="button" class="neo-btn btn-sm me-2 btn-toggle-batches" title="Show batches"
                                            aria-expanded="false" data-product-id="${x.productId}">
                                        ▸
                                    </button>
                                    <span class="fw-black text-uppercase">${escapeHtml(x.name)}</span>
                                </td>
                                <td><code class="fw-bold fs-6">${escapeHtml(x.sku)}</code></td>
                                <td class="text-end">${formatNumber(x.reorderPoint)} ${escapeHtml(x.unit)}</td>
                                <td class="text-end fw-black">${formatNumber(x.onHand)}</td>
                                <td class="text-end">${formatNumber(x.reserved)}</td>
                                <td class="text-end fw-black text-primary">${formatNumber(x.available)}</td>
                                <td><span class="badge ${badgeClass}">${statusText}</span></td>
                                <td class="text-end">
                                    <a class="neo-btn neo-btn-success btn-sm me-1" href="/Products/AddBatch/${x.productId}">ADD BATCH</a>
                                    <a class="neo-btn neo-btn-info btn-sm" href="/Products/Edit/${x.productId}">EDIT</a>
                                </td>
                            </tr>`;
                        }).join('');

                        tbody.querySelectorAll('.btn-toggle-batches').forEach(btn => {
                            btn.addEventListener('click', async function () {
                                const productId = parseInt(this.dataset.productId);
                                const tr = this.closest('tr');
                                if (!tr) return;
                                await toggleBatches(productId, tr, this);
                            });
                        });
                    })
                    .catch(err => {
                        console.error('Failed to load products:', err);
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger py-5">FETCH FAILED. REFRESH PAGE.</td></tr>';
                    });
            }

            async function toggleBatches(productId, productRow, toggleBtn) {
                const existing = productRow.nextElementSibling;
                if (existing && existing.classList.contains('batch-details-row') && existing.dataset.productId === String(productId)) {
                    const isHidden = existing.style.display === 'none';
                    existing.style.display = isHidden ? '' : 'none';
                    toggleBtn.textContent = isHidden ? '▾' : '▸';
                    return;
                }

                if (pendingRequests.has(productId)) return;

                const detailsRow = document.createElement('tr');
                detailsRow.className = 'batch-details-row';
                detailsRow.dataset.productId = String(productId);
                detailsRow.innerHTML = `<td colspan="8" class="p-4 bg-light">
                    <div class="d-flex align-items-center fw-bold">
                        <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                        LOADING BATCHES...
                    </div>
                </td>`;
                productRow.insertAdjacentElement('afterend', detailsRow);

                toggleBtn.textContent = '▾';
                toggleBtn.disabled = true;

                const abortController = new AbortController();
                pendingRequests.set(productId, abortController);

                try {
                    const resp = await fetch(`/api/products/${productId}/batches`, { signal: abortController.signal });
                    if (!resp.ok) throw new Error();
                    const batches = await resp.json();

                    if (!Array.isArray(batches) || batches.length === 0) {
                        detailsRow.innerHTML = `<td colspan="8" class="p-4 bg-light text-muted fw-bold">NO BATCHES FOUND.</td>`;
                        return;
                    }

                    detailsRow.innerHTML = `<td colspan="8" class="p-4 bg-light border-start border-end">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="fw-black text-uppercase">Batch Track Records</div>
                            <a href="/Products/AddBatch/${productId}" class="neo-btn neo-btn-sm neo-btn-success"><i class="bi bi-plus-lg"></i> ADD BATCH</a>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>BATCH #</th>
                                        <th class="text-end">ON HAND</th>
                                        <th class="text-end">RESERVED</th>
                                        <th class="text-end">AVAILABLE</th>
                                        <th class="text-end">COST</th>
                                        <th class="text-end">PRICE</th>
                                        <th>LAST MOVEMENT</th>
                                        <th>NOTES</th>
                                        <th class="text-end">ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${batches.map(b => `
                                        <tr data-batch="${escapeHtml(b.batchNumber)}" data-rowversion="${escapeHtml(b.rowVersion || '')}">
                                            <td class="fw-bold">${escapeHtml(b.batchNumber)}</td>
                                            <td class="text-end">${formatNumber(b.onHand)}</td>
                                            <td class="text-end text-muted">${formatNumber(b.reserved)}</td>
                                            <td class="text-end fw-bold text-primary">${formatNumber(b.available)}</td>
                                            <td class="text-end fw-bold text-success">${b.unitCost == null ? '-' : formatNumber(b.unitCost)}</td>
                                            <td class="text-end fw-bold text-primary">${b.unitPrice == null ? '-' : formatNumber(b.unitPrice)}</td>
                                            <td>${b.lastMovementUtc ? formatDate(b.lastMovementUtc) : '-'}</td>
                                            <td class="text-truncate" style="max-width: 250px;">${escapeHtml(b.notes || '')}</td>
                                            <td class="text-end">
                                                <button type="button" class="neo-btn btn-sm btn-edit-batch"
                                                        data-product-id="${productId}"
                                                        data-batch="${escapeHtml(b.batchNumber)}"
                                                        data-unitcost="${b.unitCost ?? ''}"
                                                        data-unitprice="${b.unitPrice ?? ''}"
                                                        data-notes="${escapeHtml(b.notes || '')}"
                                                        data-rowversion="${escapeHtml(b.rowVersion || '')}">
                                                    EDIT
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </td>`;

                    detailsRow.querySelectorAll('.btn-edit-batch').forEach(btn => {
                        btn.addEventListener('click', function () {
                            openBatchEditModal(this.dataset.productId, this.dataset.batch, this.dataset.unitcost, this.dataset.unitprice, this.dataset.notes, this.dataset.rowversion);
                        });
                    });
                } catch (e) {
                    if (e.name !== 'AbortError') detailsRow.innerHTML = `<td colspan="8" class="p-4 text-danger fw-bold">ERROR LOADING BATCHES.</td>`;
                } finally {
                    toggleBtn.disabled = false;
                    pendingRequests.delete(productId);
                }
            }

            function updateProductDropdowns(products) {
                const dropdowns = document.querySelectorAll('.product-dropdown, #receiveProductId, #issueProductId, #adjustProductId');
                const options = '<option value="">-- SELECT PRODUCT --</option>' +
                    products.map(p => `<option value="${p.productId}" data-onhand="${p.onHand}">${escapeHtml(p.name)} (${escapeHtml(p.sku)})</option>`).join('');

                dropdowns.forEach(d => { if(d) d.innerHTML = options; });
            }


            refreshDashboard();

            document.getElementById('btn-receive-stock').addEventListener('click', () => { new bootstrap.Modal(document.getElementById('receiveStockModal')).show(); });
            // Issue/Adjust now use direct links, no modal listeners needed
            document.getElementById('btn-add-product').addEventListener('click', () => { new bootstrap.Modal(document.getElementById('addProductModal')).show(); });

            document.getElementById('adjustProductId').addEventListener('change', function() {
                const product = allProductsForModals.find(p => p.productId === parseInt(this.value));
                if (product) {
                    document.getElementById('adjustQuantity').value = product.onHand;
                    document.getElementById('adjustRowVersion').value = product.stockRowVersion;
                }
            });

            function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
            function formatNumber(num) { return parseFloat(num).toLocaleString('en-US', { maximumFractionDigits: 2 }); }
            function formatDate(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso; } }

            const batchModal = new bootstrap.Modal(document.getElementById('batchEditModal'));
            function openBatchEditModal(productId, batchNumber, unitCost, unitPrice, notes, rowVersion) {
                document.getElementById('batchEditProductId').value = productId;
                document.getElementById('batchEditBatchNumber').value = batchNumber;
                document.getElementById('batchEditRowVersion').value = rowVersion || '';
                document.getElementById('batchEditUnitCost').value = unitCost || '';
                document.getElementById('batchEditUnitPrice').value = unitPrice || '';
                document.getElementById('batchEditNotes').value = notes || '';
                document.getElementById('batchEditTitle').textContent = `EDIT BATCH: ${batchNumber}`;
                batchModal.show();
            }

            document.getElementById('batchEditSave').addEventListener('click', async function () {
                const productId = document.getElementById('batchEditProductId').value;
                const batchNumber = document.getElementById('batchEditBatchNumber').value;
                const payload = {
                    unitCost: parseFloat(document.getElementById('batchEditUnitCost').value) || null,
                    unitPrice: parseFloat(document.getElementById('batchEditUnitPrice').value) || null,
                    notes: document.getElementById('batchEditNotes').value || null,
                    rowVersion: document.getElementById('batchEditRowVersion').value || null
                };

                this.disabled = true;
                try {
                    const resp = await fetch(`/api/products/${productId}/batches/${encodeURIComponent(batchNumber)}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!resp.ok) throw new Error();
                    batchModal.hide();
                    loadProducts(); // Simple refresh
                } catch (e) { if (window.appMessages) window.appMessages.showError(e.message || 'Save failed'); } finally { this.disabled = false; }
            });
        })();
    </script>
    <script src="~/js/dashboard-operations.js"></script>
}
