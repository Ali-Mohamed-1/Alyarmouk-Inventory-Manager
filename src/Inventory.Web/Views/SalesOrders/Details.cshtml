@model Inventory.Application.DTOs.SalesOrder.SalesOrderResponseDto
@{
    ViewData["Title"] = $"Order {Model.OrderNumber}";
}

<style>
    @@media print {
        .no-print, .neo-btn, header, footer, .d-flex.gap-2 { 
            display: none !important; 
        }
        .container-fluid {
            padding: 0 !important;
            margin: 0 !important;
            max-width: 100% !important;
        }
        .neo-card {
            border: 1px solid #000 !important;
            box-shadow: none !important;
        }
        
        /* Force background colors to print */
        body { 
            background: white !important; 
            color: black !important;
            -webkit-print-color-adjust: exact; 
             print-color-adjust: exact;
        }
        
        .bg-black { background-color: black !important; color: white !important; }
        .text-white { color: white !important; }

        /* Ensure table fits */
        .table-responsive {
            overflow: visible !important;
        }
        
        /* Layout adjustments for print */
        .col-lg-8 { width: 66% !important; flex: 0 0 66%; max-width: 66%; }
        .col-lg-4 { width: 33% !important; flex: 0 0 33%; max-width: 33%; }
        .row { display: flex !important; flex-wrap: wrap !important; }
    }
</style>

<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-5 no-print">
        <div>
            <h1 class="display-4 fw-black text-uppercase mb-0" style="letter-spacing: -2px;">Record ID: @Model.OrderNumber</h1>
            <p class="fw-bold text-muted mb-0">ORIGINATED: @Model.CreatedUtc.ToLocalTime().ToString("f").ToUpper()</p>
        </div>
        <div class="d-flex gap-2">
            <a asp-action="Index" class="neo-btn">BACK TO LOG</a>
            <button class="neo-btn neo-btn-primary" onclick="window.print()">PRINT HARDCOPY</button>
        </div>
    </div>

    <!-- Print Only Header -->
    <div class="d-none d-print-block mb-4">
        <h1 class="fw-black text-uppercase mb-0">Sales Order Invoice</h1>
        <div class="d-flex justify-content-between fw-bold border-bottom border-2 border-black pb-2 mt-2">
            <span>REF: @Model.OrderNumber</span>
            <span>DATE: @Model.CreatedUtc.ToLocalTime().ToString("yyyy-MM-dd")</span>
        </div>
    </div>

    <div class="row g-5">
        <!-- Main Info -->
        <div class="col-lg-8">
            <div class="neo-card p-0 overflow-hidden mb-4">
                <div class="p-3 bg-black text-white">
                    <h5 class="mb-0 fw-black text-uppercase small">Inventory Line Items</h5>
                </div>
                <div class="p-0" style="background: white;">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-dark text-white small text-uppercase fw-black">
                                <tr>
                                    <th class="ps-4">PRODUCT RECORD</th>
                                    <th>BATCH / LOT</th>
                                    <th class="text-center">QTY</th>
                                    <th class="text-end">UNIT VAL</th>
                                    <th class="text-end pe-4">LINE TOTAL</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var line in Model.Lines)
                                {
                                    <tr>
                                        <td class="ps-4 py-3">
                                            <div class="fw-black text-uppercase">@line.ProductName</div>
                                            <div class="small fw-bold text-muted">UNIT: @line.Unit.ToUpper()</div>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(line.BatchNumber))
                                            {
                                                <code class="fw-black text-black">@line.BatchNumber</code>
                                            }
                                            else
                                            {
                                                <span class="text-muted small fw-bold">GENERAL</span>
                                            }
                                        </td>
                                        <td class="text-center fw-black">@line.Quantity</td>
                                        <td class="text-end fw-bold">@line.UnitPrice.ToString("C2")</td>
                                        <td class="text-end fw-black text-primary pe-4">@line.LineTotal.ToString("C2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="p-4 bg-light border-top border-4">
                    <div class="row g-2">
                        <div class="col-9 text-end fw-black text-uppercase small">Subtotal:</div>
                        <div class="col-3 text-end fw-black">@Model.Subtotal.ToString("C2")</div>
                        
                        @if (Model.ApplyVat)
                        {
                            <div class="col-9 text-end fw-black text-uppercase small">VAT (14%):</div>
                            <div class="col-3 text-end fw-bold">@Model.VatAmount.ToString("C2")</div>
                        }
                        @if (Model.ApplyManufacturingTax)
                        {
                            <div class="col-9 text-end fw-black text-uppercase small">Manufacturing Tax (1%):</div>
                            <div class="col-3 text-end fw-bold text-danger">-@Model.ManufacturingTaxAmount.ToString("C2")</div>
                        }
                        <div class="col-9 text-end fw-black text-uppercase fs-4 mt-3">Grand Total:</div>
                        <div class="col-3 text-end fw-black fs-3 text-success mt-3">@Model.TotalAmount.ToString("C2")</div>
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Model.Note))
            {
                <div class="neo-card p-0 overflow-hidden mb-4">
                    <div class="p-3 bg-black text-white">
                        <h5 class="mb-0 fw-black text-uppercase small">Operational Context (Notes)</h5>
                    </div>
                    <div class="p-4 bg-white fw-bold">
                        <p class="mb-0">@Model.Note</p>
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar Info -->
        <div class="col-lg-4">
            <!-- Customer Info -->
            <div class="neo-card p-0 overflow-hidden mb-4">
                <div class="p-3 bg-black text-white">
                    <h5 class="mb-0 fw-black text-uppercase small">Entity Identification</h5>
                </div>
                <div class="p-4 bg-white">
                    <h4 class="fw-black text-uppercase mb-1">@Model.CustomerName</h4>
                    <p class="small fw-bold text-muted mb-0">INTERNAL ID: #@Model.CustomerId</p>
                </div>
            </div>

            <!-- Status Info -->
            <div class="neo-card p-0 overflow-hidden mb-4 border-4 @(Model.Status == Inventory.Domain.Entities.SalesOrderStatus.Done ? "border-success" : "border-info") no-print">
                <div class="p-3 @(Model.Status == Inventory.Domain.Entities.SalesOrderStatus.Done ? "bg-success text-white" : "bg-info text-black")">
                    <h5 class="mb-0 fw-black text-uppercase small">Inherent Status</h5>
                </div>
                <div class="p-4 bg-white">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="badge @(Model.Status == Inventory.Domain.Entities.SalesOrderStatus.Done ? "neo-btn-success" : "neo-btn-info") fs-5 p-2 px-3">
                            @Model.Status.ToString().ToUpper()
                        </span>
                    </div>

                    @if (Model.Status != Inventory.Domain.Entities.SalesOrderStatus.Cancelled)
                    {
                        <form asp-action="UpdateStatus" asp-route-id="@Model.Id" method="post" class="d-flex gap-2">
                            <input type="hidden" name="OrderId" value="@Model.Id" />
                            <select name="Status" class="form-select fw-black">
                                @foreach (var status in Enum.GetValues<Inventory.Domain.Entities.SalesOrderStatus>())
                                {
                                    <option value="@status" selected="@(status == Model.Status)">@status.ToString().ToUpper()</option>
                                }
                            </select>
                            <button type="submit" class="neo-btn neo-btn-primary">UPDATE</button>
                        </form>
                        if (Model.Status != Inventory.Domain.Entities.SalesOrderStatus.Done)
                        {
                            <div class="mt-3 neo-card p-2 mb-0 border-2 bg-light small fw-bold">
                                <i class="bi bi-exclamation-triangle-fill me-1 text-warning"></i> INVENTORY DEPLETION TRIGGERED UPON "DONE".
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Print Status Placeholder -->
            <div class="d-none d-print-block mb-4 border border-2 border-black p-3">
                 <div class="d-flex justify-content-between">
                     <span class="fw-bold">STATUS:</span>
                     <span class="fw-black">@Model.Status.ToString().ToUpper()</span>
                 </div>
            </div>

            <!-- Payment Info -->
            <div class="neo-card p-0 overflow-hidden mb-4" style="background: var(--neo-yellow);">
                <div class="p-3 bg-black text-white">
                    <h5 class="mb-0 fw-black text-uppercase small">Financial Settlement</h5>
                </div>
                <div class="p-4">
                    <div class="mb-4">
                        <span class="badge @(Model.PaymentStatus == Inventory.Domain.Entities.PaymentStatus.Paid ? "neo-btn-success" : "neo-btn-danger text-white") w-100 py-3 fs-5">
                            @Model.PaymentStatus.ToString().ToUpper()
                        </span>
                    </div>
                    <div class="row g-3 fw-bold">
                        <div class="col-5 text-uppercase small">Method:</div>
                        <div class="col-7 text-end fw-black d-flex justify-content-end align-items-center gap-2">
                             <span>@Model.PaymentMethod.ToString().ToUpper()</span>
                             <button class="neo-btn btn-sm py-0 no-print" style="font-size: 0.7rem;" onclick="openEditPaymentModal()">EDIT</button>
                        </div>

                        <div class="col-5 text-uppercase small">Deadline:</div>
                        <div class="col-7 text-end d-flex justify-content-end align-items-center gap-2">
                            <span>@Model.DueDate.ToString("MMM dd, yyyy").ToUpper()</span>
                            <button class="neo-btn btn-sm py-0 no-print" style="font-size: 0.7rem;" onclick="openEditDueDateModal()">EDIT</button>
                        </div>

                        @if (Model.PaymentMethod == Inventory.Domain.Entities.PaymentMethod.Check)
                        {
                            <div class="col-12 mt-4 pt-3 border-top border-black no-print">
                                <h6 class="fw-black text-uppercase small mb-3">Verification Info</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>RECEIVED:</span>
                                    <span class="badge @(Model.CheckReceived == true ? "bg-black text-white" : "bg-white text-black border border-black")">@(Model.CheckReceived == true ? "YES" : "NO")</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>CASHED:</span>
                                    <span class="badge @(Model.CheckCashed == true ? "bg-black text-white" : "bg-white text-black border border-black")">@(Model.CheckCashed == true ? "YES" : "NO")</span>
                                </div>
                            </div>
                        }
                        else if (Model.PaymentMethod == Inventory.Domain.Entities.PaymentMethod.BankTransfer)
                        {
                            <div class="col-12 mt-4 pt-3 border-top border-black">
                                <h6 class="fw-black text-uppercase small mb-2">Transfer context</h6>
                                <div class="d-flex justify-content-between">
                                    <span>TRACE ID:</span>
                                    <span class="fw-black">@(Model.TransferId ?? "N/A")</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Documents -->
            <div class="neo-card p-0 overflow-hidden no-print">
                <div class="p-3 bg-black text-white">
                    <h5 class="mb-0 fw-black text-uppercase small">Digital Audit Trail</h5>
                </div>
                <div class="p-0 bg-white">
                    @if (!string.IsNullOrEmpty(Model.InvoicePath))
                    {
                        <a href="@Model.InvoicePath" target="_blank" class="d-flex justify-content-between align-items-center p-3 text-decoration-none text-black border-bottom border-2 hover-bg-light">
                            <div class="fw-black text-uppercase small">
                                <i class="bi bi-file-earmark-pdf text-danger me-2"></i> INVOICE PDF
                            </div>
                            <i class="bi bi-download"></i>
                        </a>
                    }
                    @if (!string.IsNullOrEmpty(Model.ReceiptPath))
                    {
                        <a href="@Model.ReceiptPath" target="_blank" class="d-flex justify-content-between align-items-center p-3 text-decoration-none text-black hover-bg-light">
                            <div class="fw-black text-uppercase small">
                                <i class="bi bi-file-earmark-check text-success me-2"></i> RECEIPT PDF
                            </div>
                            <i class="bi bi-download"></i>
                        </a>
                    }
                    @if (string.IsNullOrEmpty(Model.InvoicePath) && string.IsNullOrEmpty(Model.ReceiptPath))
                    {
                        <div class="p-4 text-center text-muted fw-bold small italic">ZERO ATTACHMENTS DETECTED</div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Due Date Modal -->
<div class="modal fade" id="editDueDateModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-black text-white">
                <h5 class="modal-title fw-black text-uppercase small">Update Deadline</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label fw-black text-uppercase small">New Due Date</label>
                    <input type="date" class="form-control fw-bold" id="newDueDate" value="@Model.DueDate.ToString("yyyy-MM-dd")">
                </div>
            </div>
            <div class="modal-footer">
                <button class="neo-btn btn-sm" data-bs-dismiss="modal">CANCEL</button>
                <button class="neo-btn neo-btn-primary btn-sm" onclick="saveDueDate()">UPDATE</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Payment Info Modal -->
<div class="modal fade" id="editPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-black text-white">
                <h5 class="modal-title fw-black text-uppercase small">Update Payment Info</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="paymentForm">
                    <!-- Status -->
                    <div class="mb-3">
                        <label class="form-label fw-black text-uppercase small">Payment Status</label>
                        <select class="form-select fw-bold" id="editPaymentStatus">
                            @foreach (var status in Enum.GetValues<Inventory.Domain.Entities.PaymentStatus>())
                            {
                                <option value="@status">@status.ToString()</option>
                            }
                        </select>
                    </div>

                    <!-- Method -->
                    <div class="mb-3">
                        <label class="form-label fw-black text-uppercase small">Payment Method</label>
                        <select class="form-select fw-bold" id="editPaymentMethod" onchange="togglePaymentFields()">
                            @foreach (var method in Enum.GetValues<Inventory.Domain.Entities.PaymentMethod>())
                            {
                                <option value="@method">@method.ToString()</option>
                            }
                        </select>
                    </div>

                    <!-- Dynamic Fields: Check -->
                    <div id="checkFields" class="d-none border-top border-2 pt-3 mt-3">
                        <h6 class="fw-black text-uppercase small mb-3">Check Details</h6>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="editCheckReceived" onchange="toggleDateFields()">
                            <label class="form-check-label fw-bold" for="editCheckReceived">Received</label>
                        </div>
                        <div class="mb-3 ps-4" id="receivedDateConfig">
                            <label class="form-label small text-muted fw-bold">Received Date</label>
                            <input type="date" class="form-control" id="editCheckReceivedDate">
                        </div>

                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="editCheckCashed" onchange="toggleDateFields()">
                            <label class="form-check-label fw-bold" for="editCheckCashed">Cashed</label>
                        </div>
                        <div class="mb-3 ps-4" id="cashedDateConfig">
                            <label class="form-label small text-muted fw-bold">Cashed Date</label>
                            <input type="date" class="form-control" id="editCheckCashedDate">
                        </div>
                    </div>

                    <!-- Dynamic Fields: Bank Transfer -->
                    <div id="bankTransferFields" class="d-none border-top border-2 pt-3 mt-3">
                        <h6 class="fw-black text-uppercase small mb-3">Transfer Details</h6>
                        <div class="mb-3">
                            <label class="form-label small text-muted fw-bold">Transfer / Trace ID</label>
                            <input type="text" class="form-control fw-bold" id="editTransferId" placeholder="Enter Transaction Reference">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="neo-btn btn-sm" data-bs-dismiss="modal">CANCEL</button>
                <button class="neo-btn neo-btn-primary btn-sm" onclick="savePaymentInfo()">SAVE CHANGES</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize with server values
        const currentData = {
            status: '@Model.PaymentStatus',
            method: '@Model.PaymentMethod',
            checkReceived: @(Model.CheckReceived == true ? "true" : "false"),
            checkReceivedDate: '@(Model.CheckReceivedDate?.ToString("yyyy-MM-dd") ?? "")',
            checkCashed: @(Model.CheckCashed == true ? "true" : "false"),
            checkCashedDate: '@(Model.CheckCashedDate?.ToString("yyyy-MM-dd") ?? "")',
            transferId: '@Model.TransferId'
        };

        function openEditDueDateModal() {
            new bootstrap.Modal(document.getElementById('editDueDateModal')).show();
        }

        function openEditPaymentModal() {
            document.getElementById('editPaymentStatus').value = currentData.status;
            document.getElementById('editPaymentMethod').value = currentData.method;
            
            // Set fields provided they are relevant, otherwise defaults
            document.getElementById('editCheckReceived').checked = currentData.checkReceived;
            document.getElementById('editCheckReceivedDate').value = currentData.checkReceivedDate;
            document.getElementById('editCheckCashed').checked = currentData.checkCashed;
            document.getElementById('editCheckCashedDate').value = currentData.checkCashedDate;
            document.getElementById('editTransferId').value = currentData.transferId;

            togglePaymentFields();
            new bootstrap.Modal(document.getElementById('editPaymentModal')).show();
        }

        function togglePaymentFields() {
            const method = document.getElementById('editPaymentMethod').value;
            const checkFields = document.getElementById('checkFields');
            const bankFields = document.getElementById('bankTransferFields');

            checkFields.classList.add('d-none');
            bankFields.classList.add('d-none');

            if (method === 'Check') {
                checkFields.classList.remove('d-none');
                toggleDateFields();
            } else if (method === 'BankTransfer') {
                bankFields.classList.remove('d-none');
            }
        }

        function toggleDateFields() {
            const isReceived = document.getElementById('editCheckReceived').checked;
            const receivedDateInput = document.getElementById('editCheckReceivedDate');
            receivedDateInput.disabled = !isReceived;
            if (isReceived && !receivedDateInput.value) {
                receivedDateInput.value = new Date().toISOString().split('T')[0];
            }

            const isCashed = document.getElementById('editCheckCashed').checked;
            const cashedDateInput = document.getElementById('editCheckCashedDate');
            cashedDateInput.disabled = !isCashed;
             if (isCashed && !cashedDateInput.value) {
                cashedDateInput.value = new Date().toISOString().split('T')[0];
            }
        }

        async function savePaymentInfo() {
            const method = document.getElementById('editPaymentMethod').value;
            
            const payload = {
                orderId: @Model.Id,
                paymentStatus: document.getElementById('editPaymentStatus').value,
                paymentMethod: method,
                // Check fields
                checkReceived: document.getElementById('editCheckReceived').checked,
                checkReceivedDate: document.getElementById('editCheckReceivedDate').value ? new Date(document.getElementById('editCheckReceivedDate').value).toISOString() : null,
                checkCashed: document.getElementById('editCheckCashed').checked,
                checkCashedDate: document.getElementById('editCheckCashedDate').value ? new Date(document.getElementById('editCheckCashedDate').value).toISOString() : null,
                // Bank fields
                transferId: document.getElementById('editTransferId').value
            };

            // Sanitation based on method
            if (method !== 'Check') {
                payload.checkReceived = false;
                payload.checkReceivedDate = null;
                payload.checkCashed = false;
                payload.checkCashedDate = null;
            }
            if (method !== 'BankTransfer') {
                payload.transferId = null;
            }

            try {
                const response = await fetch('/api/sales-orders/@Model.Id/payment', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const err = await response.text();
                    alert('Failed to update payment info: ' + err);
                }
            } catch (error) {
                console.error(error);
                alert('An error occurred.');
            }
        }

        async function saveDueDate() {
            const date = document.getElementById('newDueDate').value;
            if (!date) return;
            
            try {
                // Ensure the date string is preserved as is or ISO
                const d = new Date(date);
                
                const response = await fetch('/api/sales-orders/@Model.Id/due-date', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(d.toISOString()) 
                });

                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to update due date.');
                }
            } catch (error) {
                console.error(error);
                alert('An error occurred.');
            }
        }
    </script>
}

