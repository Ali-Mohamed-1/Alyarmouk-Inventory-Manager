@model Inventory.Application.DTOs.PurchaseOrder.CreatePurchaseOrderRequest
@{
    ViewData["Title"] = "Record Historical Purchase Order";
    var suppliers = ViewBag.Suppliers as IEnumerable<Inventory.Application.DTOs.Supplier.SupplierDropdownResponse> ?? new List<Inventory.Application.DTOs.Supplier.SupplierDropdownResponse>();
    var products = ViewBag.Products as IEnumerable<Inventory.Application.DTOs.Product.ProductResponseDto> ?? new List<Inventory.Application.DTOs.Product.ProductResponseDto>();
}

<style>
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
</style>

<div class="container-fluid py-3">
    <div class="alert alert-warning border-3 fw-bold mb-4">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        HISTORICAL MODE: Recording past purchase. Stock will NOT be added to inventory upon creation. You must manually activate stock later if desired.
    </div>

    <div class="d-flex justify-content-between align-items-center mb-5">
        <h1 class="display-4 fw-black text-uppercase mb-0" style="letter-spacing: -2px;">Record <span class="text-warning">Historical Purchase</span></h1>
        
        <div class="ms-auto">
            <a asp-controller="RecordHistory" asp-action="Index" class="text-decoration-none text-muted small fw-bold mb-0">
                <i class="bi bi-arrow-left me-1"></i> BACK TO HISTORY
            </a>
        </div>
    </div>

    <form asp-action="Create" method="post" id="createOrderForm">
        @Html.AntiForgeryToken()
        <input type="hidden" name="IsHistorical" value="true" />
        <input type="hidden" name="ConnectToReceiveStock" value="false" />

        <div class="row g-5">
            <!-- Left Side -->
            <div class="col-lg-3">
                <div class="neo-card p-0 overflow-hidden mb-4">
                    <div class="p-3 bg-warning text-dark">
                        <h5 class="mb-0 fw-black text-uppercase small">Historical Record Params</h5>
                    </div>
                    <div class="p-4" style="background: white;">
                        <div class="mb-4">
                            <label asp-for="SupplierId" class="form-label fw-black text-uppercase small">Supplier</label>
                            <select asp-for="SupplierId" class="form-select fw-bold" required>
                                <option value="">-- SELECT SUPPLIER --</option>
                                @foreach (var s in suppliers)
                                {
                                    <option value="@s.Id">@s.Name.ToUpper()</option>
                                }
                            </select>
                            <span asp-validation-for="SupplierId" class="text-danger small fw-bold"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="OrderDate" class="form-label fw-black text-uppercase small">Original Order Date</label>
                            <input asp-for="OrderDate" type="date" class="form-control fw-bold" id="OrderDateInput" value="@Model.OrderDate?.ToString("yyyy-MM-dd")" required />
                            <span asp-validation-for="OrderDate" class="text-danger small fw-bold"></span>
                        </div>
                        
                        <div class="mb-4">
                             <label name="Status" class="form-label fw-black text-uppercase small">Historical Status</label>
                             <select name="Status" class="form-select fw-bold">
                                 <option value="Received" selected>RECEIVED (Stock In Hand)</option>
                                 <option value="Pending">PENDING (Not Received)</option>
                             </select>
                             <div class="form-text small">
                                 "Received" implies you physically received execution in the past. Stock impact is deferred.
                             </div>
                        </div>

                        <div class="mb-4">
                            <label asp-for="DueDate" class="form-label fw-black text-uppercase small">Payment Deadline</label>
                            <input asp-for="DueDate" type="date" class="form-control fw-bold" id="DueDateInput" value="@Model.DueDate?.ToString("yyyy-MM-dd")" />
                        </div>

                        <div class="mb-0">
                            <label asp-for="Note" class="form-label fw-black text-uppercase small">Legacy Notes</label>
                            <textarea asp-for="Note" class="form-control fw-bold" rows="3" placeholder="Original PO ref..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Financials -->
                <div class="neo-card p-0 overflow-hidden mb-4" style="background: var(--neo-yellow);">
                    <div class="p-3 bg-warning text-dark">
                        <h5 class="mb-0 fw-black text-uppercase small">Settlement Record</h5>
                    </div>
                     <div class="p-4 bg-dark">
                        <div class="mb-4">
                            <label asp-for="PaymentMethod" class="form-label fw-black text-uppercase small text-white">Method</label>
                            <select asp-for="PaymentMethod" class="form-select fw-black">
                                <option value="1">CASH</option>
                                <option value="2">CHECK / CHEQUE</option>
                                <option value="3">BANK TRANSFER</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label asp-for="PaymentStatus" class="form-label fw-black text-uppercase small text-white">Payment Status</label>
                            <select asp-for="PaymentStatus" class="form-select fw-black text-center">
                                <option value="1">PAID</option> <!-- 1 is Paid for PO -->
                                <option value="0">UNPAID</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label asp-for="ReceiptExpenses" class="form-label fw-black text-uppercase small text-white">Receipt Expenses</label>
                            <input asp-for="ReceiptExpenses" type="number" step="0.01" class="form-control fw-black bg-white small" placeholder="0.00" />
                        </div>

                        <div class="neo-card p-3 bg-white mb-0 border-2">
                            <div class="form-check mb-2">
                                <input asp-for="ApplyVat" class="form-check-input" type="checkbox" checked onchange="calculateTotals()">
                                <label class="form-check-label fw-black small ms-2" asp-for="ApplyVat">Apply VAT (14%)</label>
                            </div>
                            <div class="form-check mb-0">
                                <input asp-for="ApplyManufacturingTax" class="form-check-input" type="checkbox" checked onchange="calculateTotals()">
                                <label class="form-check-label fw-black small ms-2" asp-for="ApplyManufacturingTax">Apply MAN. Tax (1%)</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side: Order Items -->
            <div class="col-lg-9">
                <div class="neo-card p-0 h-100 d-flex flex-column">
                    <div class="p-3 bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-black text-uppercase small">Inventory Line Items</h5>
                        <button type="button" class="neo-btn neo-btn-success btn-sm" onclick="addLineItem()">
                            <i class="bi bi-plus-lg"></i> ADD ITEM
                        </button>
                    </div>
                    <div class="p-0 flex-grow-1" style="background: white;">
                        <div class="alert alert-info border-0 rounded-0 mb-0 small">
                            <i class="bi bi-info-circle me-2"></i>
                            Select existing batches if possible. If stock was different in the past, ensure you have a batch to reference, or select any batch if you don't intend to activate stock for inventory tracking.
                        </div>
                        <div class="w-100" style="min-height: 300px; overflow: visible;">
                            <table class="table table-hover align-middle mb-0" id="itemsTable">
                                <thead class="table-dark text-white small text-uppercase fw-black">
                                    <tr>
                                        <th style="width: 40%; min-width: 300px;" class="ps-4">PRODUCT RECORD</th>
                                        <th style="width: 25%; min-width: 200px;">BATCH / LOT</th>
                                        <th style="width: 15%">QUANTITY</th>
                                        <th style="width: 15%">UNIT COST</th>
                                        <th style="width: 5%" class="text-end pe-4">TRASH</th>
                                    </tr>
                                </thead>
                                <tbody id="lineItemsContainer">
                                    <!-- Lines added here via JS -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="emptyState" class="text-center py-5">
                            <i class="bi bi-cart-x text-muted" style="font-size: 4rem; opacity: 0.2;"></i>
                            <p class="fw-black text-muted mt-3">MANIFEST IS CURRENTLY EMPTY.</p>
                            <button type="button" class="neo-btn" onclick="addLineItem()">COMMENCE ENTRY</button>
                        </div>
                    </div>
                    <div class="p-4 border-top border-4 bg-white">
                        <div class="row g-4 align-items-end">
                            <div class="col-md-5">
                                <div class="neo-card p-3 bg-light mb-0 border-2">
                                    <p class="small text-muted mb-0 fw-bold">FINAL TOTAL WILL BE RECALCULATED ON SERVER CORE.</p>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-black text-uppercase small">SUBTOTAL:</span>
                                    <span id="displaySubtotal" class="fw-black">$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-black text-uppercase small text-muted">VAT (14%):</span>
                                    <span id="displayVat" class="fw-black text-muted">$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-black text-uppercase small text-muted">MAN. TAX (1%):</span>
                                    <span id="displayManTax" class="fw-black text-muted">$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-black text-uppercase small text-muted">RECEIPT EXPENSES:</span>
                                    <span id="displayReceiptExp" class="fw-black text-muted">$0.00</span>
                                </div>

                                <div class="d-flex justify-content-between mb-4 border-top border-2 pt-2">
                                    <span class="fw-black text-uppercase fs-5">EST. GRAND TOTAL:</span>
                                    <span id="displayTotal" class="fw-black fs-4 text-success">$0.00</span>
                                </div>
                                <button type="submit" class="neo-btn neo-btn-warning w-100 py-3 fw-black fs-5">
                                    <i class="bi bi-check2-circle me-2"></i> RECORD PURCHASE
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        let lineCount = 0;
        let products = [];

        // Global click handler to close dropdowns
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.searchable-dropdown')) {
                document.querySelectorAll('.searchable-dropdown .dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        async function loadProducts() {
            try {
                const response = await fetch('/api/products/with-stock');
                products = await response.json();
                if (lineCount === 0) addLineItem();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        async function fetchBatches(productId) {
            try {
                const response = await fetch(`/api/products/${productId}/batches`);
                const allBatches = await response.json();
                return allBatches; // For purchases, show all, even 0 stock batches if they exist
            } catch (error) {
                console.error('Error loading batches:', error);
                return [];
            }
        }

        function setupDropdown(input, list, items, onSelect, itemRenderer) {
            const show = () => {
                document.querySelectorAll('.searchable-dropdown .dropdown-menu.show').forEach(m => m !== list && m.classList.remove('show'));
                
                list.innerHTML = '';
                const filter = input.value.toLowerCase();
                const filtered = items.filter(i => itemRenderer(i).text.toLowerCase().includes(filter));
                
                if (filtered.length === 0) {
                    list.innerHTML = '<li class="dropdown-item text-muted small">No matches found</li>';
                } else {
                    filtered.forEach(item => {
                        const rendered = itemRenderer(item);
                        const li = document.createElement('li');
                        li.className = 'dropdown-item small py-2 border-bottom';
                        li.style.cursor = 'pointer';
                        li.style.whiteSpace = 'normal';
                        li.innerHTML = rendered.html;
                        li.onclick = () => {
                            input.value = rendered.text;
                            onSelect(item);
                            list.classList.remove('show');
                        };
                        list.appendChild(li);
                    });
                }
                list.classList.add('show');
            };

            input.addEventListener('focus', show);
            input.addEventListener('input', show);
        }

        function addLineItem() {
            if (products.length === 0 && lineCount > 0) return; // Prevent adding if products not loaded yet
            
            const container = document.getElementById('lineItemsContainer');
            const emptyState = document.getElementById('emptyState');
            emptyState.style.display = 'none';

            const idx = lineCount++;
            const row = document.createElement('tr'); row.id = `line-row-${idx}`;
            
            row.innerHTML = `
                <td class="ps-4 py-3 align-top">
                    <div class="searchable-dropdown position-relative" id="product-dropdown-${idx}">
                        <input type="text" class="form-control fw-black text-uppercase" placeholder="SEARCH PRODUCT..." id="product-search-${idx}" autocomplete="off">
                        <input type="hidden" name="Lines[${idx}].ProductId" id="product-id-input-${idx}" required>
                        <ul class="dropdown-menu w-100 shadow-lg border-0 rounded-0" id="product-list-${idx}" style="max-height: 300px; overflow-y: auto;"></ul>
                    </div>
                </td>
                <td class="align-top">
                    <div class="searchable-dropdown position-relative" id="batch-dropdown-${idx}">
                        <input type="text" class="form-control fw-bold small" placeholder="SELECT BATCH" id="batch-search-${idx}" disabled autocomplete="off">
                        <input type="hidden" name="Lines[${idx}].BatchNumber" id="batch-number-input-${idx}" required>
                        <ul class="dropdown-menu w-100 shadow-lg border-0 rounded-0" id="batch-list-${idx}" style="max-height: 300px; overflow-y: auto;"></ul>
                    </div>
                </td>
                <td class="align-top">
                    <input name="Lines[${idx}].Quantity" type="number" step="0.01" class="form-control fw-black text-center item-qty" onchange="calculateTotals()" value="1.00" required />
                </td>
                <td class="align-top">
                    <input name="Lines[${idx}].UnitPrice" id="price-input-${idx}" type="number" step="0.01" class="form-control fw-black item-price small" onchange="calculateTotals()" value="0.00" required />
                </td>
                <td class="text-end pe-4 align-top">
                    <button type="button" class="neo-btn neo-btn-danger btn-sm py-1" onclick="removeLineItem(${idx})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            container.appendChild(row);

            const pInput = document.getElementById(`product-search-${idx}`);
            const pList = document.getElementById(`product-list-${idx}`);
            
            // If products aren't loaded yet, we'll need to wait
            if (products.length === 0) {
                 // Skip dropdown setup until loaded
            } else {
                setupProductDropdown(idx);
            }

            calculateTotals();
        }

        function setupProductDropdown(idx) {
            const pInput = document.getElementById(`product-search-${idx}`);
            const pList = document.getElementById(`product-list-${idx}`);

            setupDropdown(pInput, pList, products, async (product) => {
                document.getElementById(`product-id-input-${idx}`).value = product.productId;
                document.getElementById(`price-input-${idx}`).value = "0.00";
                
                const bInput = document.getElementById(`batch-search-${idx}`);
                const bList = document.getElementById(`batch-list-${idx}`);
                bInput.value = '';
                bInput.disabled = true;
                document.getElementById(`batch-number-input-${idx}`).value = '';
                
                const batches = await fetchBatches(product.productId);
                
                if (batches.length > 0) {
                    bInput.disabled = false;
                    bInput.placeholder = "SELECT BATCH...";
                    
                    setupDropdown(bInput, bList, batches, (batch) => {
                        document.getElementById(`batch-number-input-${idx}`).value = batch.batchNumber;
                        const cost = batch.unitCost || batch.UnitCost || 0;
                        document.getElementById(`price-input-${idx}`).value = cost.toFixed(2);
                        calculateTotals();
                    }, (batch) => {
                        const cost = batch.unitCost || batch.UnitCost || 0;
                        return {
                            text: batch.batchNumber,
                            html: `
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">${batch.batchNumber}</span>
                                    <span class="badge bg-dark text-white rounded-pill">Stock: ${batch.onHand}</span>
                                </div>
                                <div class="small text-muted">Cost: $${cost.toFixed(2)}</div>
                            `
                        };
                    });
                } else {
                    bInput.disabled = false;
                    bInput.placeholder = "NEW BATCH (OR TYPE)";
                    // Allow typing manual batch if none exist
                    bInput.onchange = () => {
                        document.getElementById(`batch-number-input-${idx}`).value = bInput.value;
                    };
                }

                calculateTotals();
            }, (product) => {
                return {
                    text: product.name.toUpperCase(),
                    html: `
                        <div class="fw-bold">${product.name.toUpperCase()}</div>
                        <div class="d-flex justify-content-between small text-muted">
                            <span>SKU: ${product.sku}</span>
                            <span>Stock: ${product.onHand} ${product.unit}</span>
                        </div>
                    `
                };
            });
        }

        function removeLineItem(idx) {
            document.getElementById(`line-row-${idx}`).remove();
            if (document.querySelectorAll('#lineItemsContainer tr').length === 0) {
                document.getElementById('emptyState').style.display = 'block';
            }
            calculateTotals();
        }

        function calculateTotals() {
            const round = (val) => Math.round(val * 100) / 100;

            let subtotal = 0;
            const qtys = document.querySelectorAll('.item-qty');
            const prices = document.querySelectorAll('.item-price');
            for (let i = 0; i < qtys.length; i++) {
                subtotal += (parseFloat(qtys[i].value) || 0) * (parseFloat(prices[i].value) || 0);
            }
            subtotal = round(subtotal);
            
            const receiptExp = round(parseFloat(document.querySelector('[name="ReceiptExpenses"]').value) || 0);
            const applyVat = document.querySelector('[name="ApplyVat"]').checked;
            const applyManTax = document.querySelector('[name="ApplyManufacturingTax"]').checked;

            let vat = 0;
            let manTax = 0;

            if (applyVat) vat = round(subtotal * 0.14);
            if (applyManTax) manTax = round(subtotal * 0.01);

            const grandTotal = round(subtotal + vat - manTax + receiptExp);

            document.getElementById('displaySubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('displayVat').textContent = formatCurrency(vat);
            document.getElementById('displayManTax').textContent = (manTax > 0 ? "-" : "") + formatCurrency(manTax);
            document.getElementById('displayReceiptExp').textContent = formatCurrency(receiptExp);
            document.getElementById('displayTotal').textContent = formatCurrency(grandTotal);

        }

        function formatCurrency(a) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(a); }

        (async function() {
            await loadProducts();
            // After loading, ensure any existing line item dropdowns are bound
            for(let i=0; i<lineCount; i++) {
                if(document.getElementById(`product-search-${i}`)) setupProductDropdown(i);
            }
        })();

        document.querySelectorAll('[name="ApplyVat"], [name="ApplyManufacturingTax"], [name="ReceiptExpenses"]').forEach(input => {
            input.addEventListener('change', calculateTotals);
            if (input.name === "ReceiptExpenses") input.addEventListener('input', calculateTotals);
        });

        // Deadline auto-calculation logic
        let deadlineManuallyChanged = false;
        const orderDateInput = document.getElementById('OrderDateInput');
        const dueDateInput = document.getElementById('DueDateInput');

        if (orderDateInput && dueDateInput) {
            orderDateInput.addEventListener('change', function() {
                if (!deadlineManuallyChanged) {
                    const orderDate = new Date(this.value);
                    if (!isNaN(orderDate.getTime())) {
                        const dueDate = new Date(orderDate);
                        dueDate.setMonth(dueDate.getMonth() + 1);
                        
                        // Format to yyyy-MM-dd
                        const year = dueDate.getFullYear();
                        const month = String(dueDate.getMonth() + 1).padStart(2, '0');
                        const day = String(dueDate.getDate()).padStart(2, '0');
                        dueDateInput.value = `${year}-${month}-${day}`;
                    }
                }
            });

            dueDateInput.addEventListener('change', function() {
                deadlineManuallyChanged = true;
            });
        }
    </script>
}
