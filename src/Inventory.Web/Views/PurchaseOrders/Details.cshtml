@model Inventory.Application.DTOs.PurchaseOrderResponse
@{
    ViewData["Title"] = $"PO {Model.OrderNumber}";
    var returnUrl = Context.Request.Query["returnUrl"].ToString();
}

<style>
    @@media print {
        .no-print, .neo-btn, header, footer, .d-flex.gap-2.align-items-center { 
            display: none !important; 
        }
        .container-fluid {
            padding: 0 !important;
            margin: 0 !important;
            max-width: 100% !important;
        }
        .neo-card {
            border: 1px solid #000 !important;
            box-shadow: none !important;
        }
        body { 
            background: white !important; 
            color: black !important;
            -webkit-print-color-adjust: exact; 
        }
        /* Ensure table fits */
        .table-responsive {
            overflow: visible !important;
        }
    }
</style>

<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-5 no-print">
        <div>
            <h1 class="display-4 fw-black text-uppercase mb-0" style="letter-spacing: -2px;">PO ID: @Model.OrderNumber</h1>
            <p class="fw-bold text-muted mb-0">ISSUED: @Model.CreatedUtc.ToLocalTime().ToString("f").ToUpper()</p>
            <p class="fw-bold text-danger mb-0">DEADLINE: @(Model.PaymentDeadline.HasValue ? Model.PaymentDeadline.Value.ToLocalTime().ToString("f").ToUpper() : "N/A")</p>
        </div>
        <div class="d-flex gap-2">
            @if (!string.IsNullOrEmpty(returnUrl))
            {
                <a href="@returnUrl" class="neo-btn">Back</a>
            }
            else
            {
                <a asp-controller="Dashboard" asp-action="Index" class="neo-btn">Back</a>
            }
            <button class="neo-btn neo-btn-primary" onclick="window.print()">PRINT HARDCOPY</button>
        </div>
    </div>

    <!-- Print Only Header -->
    <div class="d-none d-print-block mb-4">
        <h1 class="fw-black text-uppercase mb-0">Purchase Order</h1>
        <div class="d-flex justify-content-between fw-bold border-bottom border-2 border-black pb-2 mt-2">
            <span>REF: @Model.OrderNumber</span>
            <span>DATE: @Model.CreatedUtc.ToLocalTime().ToString("yyyy-MM-dd")</span>
            <span>DEADLINE: @(Model.PaymentDeadline.HasValue ? Model.PaymentDeadline.Value.ToLocalTime().ToString("yyyy-MM-dd") : "N/A")</span>
        </div>
    </div>

    <div class="row g-5">
        <!-- Main Info -->
        <div class="col-lg-8">
            <div class="neo-card p-0 overflow-hidden mb-4">
                <div class="p-3 bg-black text-white">
                    <h5 class="mb-0 fw-black text-uppercase small">Acquisition Manifest</h5>
                </div>
                <div class="p-0" style="background: white;">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-dark text-white small text-uppercase fw-black">
                                <tr>
                                    <th class="ps-4">PRODUCT RECORD</th>
                                    <th>BATCH / LOT</th>
                                    <th class="text-center">QTY</th>
                                    <th class="text-end">UNIT COST</th>
                                    <th class="text-end pe-4">LINE TOTAL</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var line in Model.Lines)
                                {
                                    <tr>
                                        <td class="ps-4 py-3">
                                            <div class="fw-black text-uppercase">@line.ProductName</div>
                                            <div class="small fw-bold text-muted">UNIT: @line.Unit.ToUpper()</div>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(line.BatchNumber))
                                            {
                                                <code class="fw-black text-black">@line.BatchNumber</code>
                                            }
                                            else
                                            {
                                                <span class="text-muted small fw-bold">GENERAL</span>
                                            }
                                        </td>
                                        <td class="text-center fw-black">@line.Quantity</td>
                                        <td class="text-end fw-bold">@line.UnitPrice.ToString("C2")</td>
                                        <td class="text-end fw-black text-primary pe-4">@line.LineTotal.ToString("C2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="p-4 bg-light border-top border-4">
                    <div class="row g-2">
                        <div class="col-9 text-end fw-black text-uppercase small">Subtotal:</div>
                        <div class="col-3 text-end fw-black">@Model.Subtotal.ToString("C2")</div>
                        
                        @if (Model.ApplyVat)
                        {
                            <div class="col-9 text-end fw-black text-uppercase small">VAT (14%):</div>
                            <div class="col-3 text-end fw-bold">@Model.VatAmount.ToString("C2")</div>
                        }
                        @if (Model.ApplyManufacturingTax)
                        {
                            <div class="col-9 text-end fw-black text-uppercase small">Manufacturing Tax (1%):</div>
                            <div class="col-3 text-end fw-bold text-danger">-@Model.ManufacturingTaxAmount.ToString("C2")</div>
                        }
                         @if (Model.ReceiptExpenses > 0)
                        {
                            <div class="col-9 text-end fw-black text-uppercase small">Receipt / Shipping Exps:</div>
                            <div class="col-3 text-end fw-bold">@Model.ReceiptExpenses.ToString("C2")</div>
                        }
                        <div class="col-9 text-end fw-black text-uppercase fs-4 mt-3">Grand Total:</div>
                        <div class="col-3 text-end fw-black fs-3 text-success mt-3">@Model.TotalAmount.ToString("C2")</div>
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Model.Note))
            {
                <div class="neo-card p-0 overflow-hidden mb-4">
                    <div class="p-3 bg-black text-white">
                        <h5 class="mb-0 fw-black text-uppercase small">Operational Context (Notes)</h5>
                    </div>
                    <div class="p-4 bg-white fw-bold">
                        <p class="mb-0">@Model.Note</p>
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar Info -->
        <div class="col-lg-4">
            <!-- Supplier Info -->
            <div class="neo-card p-0 overflow-hidden mb-4">
                <div class="p-3 bg-black text-white">
                    <h5 class="mb-0 fw-black text-uppercase small">Supplier Identity</h5>
                </div>
                <div class="p-4 bg-white">
                    <h4 class="fw-black text-uppercase mb-1">@Model.SupplierName</h4>
                    <p class="small fw-bold text-muted mb-0">SYSTEM ID: #@Model.SupplierId</p>
                </div>
            </div>

            <!-- Status Info (No Print) -->
            <div class="neo-card p-0 overflow-hidden mb-4 border-4 @(Model.Status == Inventory.Domain.Entities.PurchaseOrderStatus.Received ? "border-success" : "border-info") no-print">
                <div class="p-3 @(Model.Status == Inventory.Domain.Entities.PurchaseOrderStatus.Received ? "bg-success text-white" : "bg-info text-black")">
                    <h5 class="mb-0 fw-black text-uppercase small">Current Status</h5>
                </div>
                <div class="p-4 bg-white">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="badge @(Model.Status == Inventory.Domain.Entities.PurchaseOrderStatus.Received ? "neo-btn-success" : "neo-btn-info") fs-5 p-2 px-3">
                            @Model.Status.ToString().ToUpper()
                        </span>
                        @if (Model.IsHistorical)
                        {
                            <span class="badge bg-warning text-black border border-black ms-2">HISTORICAL</span>
                        }
                    </div>

                    @if (Model.IsHistorical)
                    {
                        <div class="mb-3 p-3 bg-light border border-2 border-black">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-black small text-uppercase">Stock Impact:</span>
                                @if (Model.IsStockProcessed)
                                {
                                    <span class="badge bg-success text-white">PROCESSED</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger text-white">DEFERRED</span>
                                }
                            </div>
                            
                            @if (!Model.IsStockProcessed)
                            {
                                <div class="small fw-bold text-muted mb-2">
                                    Inventory was not affected during creation. 
                                    @if(Model.Status == Inventory.Domain.Entities.PurchaseOrderStatus.Received)
                                    {
                                        <span>Click below to manually add stock now.</span>
                                    }
                                    else
                                    {
                                        <span>Mark as RECEIVED to enable stock addition.</span>
                                    }
                                </div>
                                @if(Model.Status == Inventory.Domain.Entities.PurchaseOrderStatus.Received)
                                {
                                    <form asp-action="ActivateStock" asp-route-id="@Model.Id" method="post">
                                        <button type="submit" class="neo-btn neo-btn-primary w-100 text-uppercase">
                                            <i class="bi bi-box-seam me-2"></i> Activate Stock Only
                                        </button>
                                    </form>
                                }
                            }
                        </div>
                    }

                    @if (Model.Status != Inventory.Domain.Entities.PurchaseOrderStatus.Cancelled)
                    {
                            var allowedStatuses = new[]
                            {
                                Inventory.Domain.Entities.PurchaseOrderStatus.Pending,
                                Inventory.Domain.Entities.PurchaseOrderStatus.Received
                            };

                            var remainingStockQuantity = Model.Lines.Sum(l => l.Quantity - l.RefundedQuantity);
                            var canCancel =
                                Model.PaymentStatus == Inventory.Domain.Entities.PurchasePaymentStatus.Unpaid &&
                                Model.PaidAmount == 0m &&
                                (Model.Status != Inventory.Domain.Entities.PurchaseOrderStatus.Received || remainingStockQuantity == 0m);

                            var cancelTooltip = canCancel
                                ? "Cancel this order (no automatic refunds will occur)."
                                : "You must fully refund stock and money before cancelling this order.";


                        <form asp-action="UpdateStatus" asp-route-id="@Model.Id" method="post" class="d-flex gap-2 mb-2">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <select name="status" class="form-select fw-black">
                                @foreach (var status in allowedStatuses)
                                {
                                    <option value="@status" selected="@(status == Model.Status)">@status.ToString().ToUpper()</option>
                                }
                            </select>
                            <button type="submit" class="neo-btn neo-btn-primary">UPDATE</button>
                        </form>

                        <form asp-action="Cancel" asp-route-id="@Model.Id" method="post" class="d-flex gap-2">
                            @Html.AntiForgeryToken()
                            <button type="submit"
                                    class="neo-btn neo-btn-danger w-100"
                                    title="@cancelTooltip"
                                    @(canCancel ? "" : "disabled")>
                                CANCEL ORDER
                            </button>
                        </form>

                        @if (Model.Status != Inventory.Domain.Entities.PurchaseOrderStatus.Received)
                        {
                            <div class="mt-3 neo-card p-2 mb-0 border-2 bg-light small fw-bold">
                                <i class="bi bi-info-circle-fill me-1 text-primary"></i> STOCK IS RECEIVED UPON "RECEIVED" STATUS.
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Print Status (Visible on Print) -->
            <div class="d-none d-print-block mb-4 border border-2 border-black p-3">
                 <div class="d-flex justify-content-between">
                     <span class="fw-bold">STATUS:</span>
                     <span class="fw-black">@Model.Status.ToString().ToUpper()</span>
                 </div>
                 <div class="d-flex justify-content-between">
                     <span class="fw-bold">PAYMENT:</span>
                     <span class="fw-black">@Model.PaymentStatus.ToString().ToUpper()</span>
                 </div>
            </div>

            <!-- Payment Info -->
            <div class="neo-card p-0 overflow-hidden mb-4" style="background: var(--neo-yellow);">
                <div class="p-3 bg-black text-white">
                    <h5 class="mb-0 fw-black text-uppercase small">Financial Settlement</h5>
                </div>
                <div class="p-4">
                    <div class="mb-4">
                        <span class="badge @(Model.PaymentStatus == Inventory.Domain.Entities.PurchasePaymentStatus.Paid ? "neo-btn-success" : (Model.PaymentStatus == Inventory.Domain.Entities.PurchasePaymentStatus.PartiallyPaid ? "neo-btn-warning" : (Model.IsOverdue ? "bg-black text-danger border border-danger shadow-lg animate__animated animate__pulse animate__infinite" : "neo-btn-danger text-white"))) w-100 py-3 fs-5">
                            @(Model.PaymentStatus == Inventory.Domain.Entities.PurchasePaymentStatus.PartiallyPaid ? "PARTIAL" : Model.PaymentStatus.ToString().ToUpper()) @(Model.IsOverdue ? " (OVERDUE)" : "")
                        </span>
                    </div>
                    <div class="row g-3 fw-bold">
                        <div class="col-6 text-uppercase small">Total:</div>
                        <div class="col-6 text-end fw-black">@Model.TotalAmount.ToString("C2")</div>
                        
                        <div class="col-6 text-uppercase small">Paid:</div>
                        <div class="col-6 text-end fw-black text-success">@Model.PaidAmount.ToString("C2")</div>
                        
                        <div class="col-6 text-uppercase small">Remaining:</div>
                        <div class="col-6 text-end fw-black @(Model.RemainingAmount > 0 ? "text-danger" : "text-success")">@Model.RemainingAmount.ToString("C2")</div>

                        <div class="col-12 mt-2">
                             @if (Model.RemainingAmount > 0)
                             {
                                 <button class="neo-btn neo-btn-primary w-100 py-2 no-print" onclick="openRecordPaymentModal()">RECORD PAYMENT</button>
                             }
                             else
                             {
                                 <button class="neo-btn neo-btn-success w-100 py-2 no-print" disabled>FULLY PAID</button>
                             }
                        </div>
                        @{
                            var canRefundMoneyPo = Model.Status != Inventory.Domain.Entities.PurchaseOrderStatus.Cancelled && 
                                (Model.PaidAmount - Model.RefundedAmount) > 0;
                            var canRefundStockPo = Model.Status == Inventory.Domain.Entities.PurchaseOrderStatus.Received && Model.Lines.Any(l => l.Quantity - l.RefundedQuantity > 0);
                            var showRefundButtonPo = canRefundMoneyPo || canRefundStockPo;
                            var refundTooltipPo = !showRefundButtonPo
                                ? "You must fully refund stock and money before cancelling this order."
                                : (canRefundMoneyPo && canRefundStockPo)
                                    ? "Refund money and/or return products to supplier."
                                    : canRefundMoneyPo
                                        ? "Refund money to supplier."
                                        : "Return products to supplier.";
                        }
                        @if (showRefundButtonPo)
                        {
                            <div class="col-12 mt-2">
                                <button class="neo-btn neo-btn-danger w-100 py-2 no-print" onclick="openPoRefundModal()" title="@refundTooltipPo">REFUND</button>
                            </div>
                        }
                        
                        <div class="col-12 mt-1">
                             <div class="d-flex justify-content-between small opacity-75">
                                 <span>DEADLINE: @(Model.PaymentDeadline.HasValue ? Model.PaymentDeadline.Value.ToString("MMM dd").ToUpper() : "N/A")</span>
                                 <a href="javascript:void(0)" class="text-black no-print" onclick="openEditPaymentDeadlineModal()">EDIT</a>
                             </div>
                        </div>

                        <div class="col-12 mt-1">
                             <div class="d-flex justify-content-between small opacity-75">
                                 <span>PAYMENT METADATA</span>
                                 <a href="javascript:void(0)" class="text-black no-print" onclick="openEditPaymentInfoModal()">EDIT INFO</a>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment History -->
            <div class="neo-card p-0 overflow-hidden mb-4 no-print">
                <div class="p-3 bg-black text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-black text-uppercase small">Payment History</h5>
                    <span class="badge bg-white text-black fw-black">@Model.Payments.Count</span>
                </div>
                <div class="p-0 bg-white">
                    @if (Model.Payments.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0 fw-bold small">
                                <thead class="table-dark text-white tiny fw-black">
                                    <tr>
                                        <th class="ps-3">DATE</th>
                                        <th>TYPE</th>
                                        <th class="text-end pe-3">AMOUNT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var p in Model.Payments)
                                    {
                                        <tr class="@(p.PaymentType == Inventory.Domain.Entities.PaymentRecordType.Refund ? "table-danger" : "")">
                                            <td class="ps-3">@p.PaymentDate.ToLocalTime().ToString("MMM dd")</td>
                                            <td>
                                                @p.PaymentType.ToString().ToUpper()
                                                @if (!string.IsNullOrEmpty(p.Reference))
                                                {
                                                    <br/><span class="tiny text-muted">@p.Reference</span>
                                                }
                                            </td>
                                            <td class="text-end pe-3 fw-black @(p.PaymentType == Inventory.Domain.Entities.PaymentRecordType.Refund ? "text-danger" : "text-success")">
                                                @(p.PaymentType == Inventory.Domain.Entities.PaymentRecordType.Refund ? "-" : "")@p.Amount.ToString("N2")
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="p-4 text-center text-muted fw-bold small italic">NO PAYMENTS RECORDED</div>
                    }
                </div>
            </div>
            
             <!-- Documents (No Print) -->
            <div class="neo-card p-0 overflow-hidden no-print">
                <div class="p-3 bg-black text-white">
                    <h5 class="mb-0 fw-black text-uppercase small">Attachments</h5>
                </div>
                <div class="p-0 bg-white">
                    @if (!string.IsNullOrEmpty(Model.InvoicePath))
                    {
                        <a href="@Model.InvoicePath" target="_blank" class="d-flex justify-content-between align-items-center p-3 text-decoration-none text-black border-bottom border-2 hover-bg-light">
                            <div class="fw-black text-uppercase small">
                                <i class="bi bi-file-earmark-pdf text-danger me-2"></i> INVOICE PDF
                            </div>
                            <i class="bi bi-download"></i>
                        </a>
                    }
                     @if (!string.IsNullOrEmpty(Model.ReceiptPath))
                    {
                        <a href="@Model.ReceiptPath" target="_blank" class="d-flex justify-content-between align-items-center p-3 text-decoration-none text-black border-bottom border-2 hover-bg-light">
                            <div class="fw-black text-uppercase small">
                                <i class="bi bi-file-earmark-check text-success me-2"></i> RECEIPT PDF
                            </div>
                            <i class="bi bi-download"></i>
                        </a>
                    }
                    @if (string.IsNullOrEmpty(Model.InvoicePath) && string.IsNullOrEmpty(Model.ReceiptPath))
                    {
                        <div class="p-4 text-center text-muted fw-bold small italic">NO FILES ATTACHED</div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Refund Modal -->
<div class="modal fade" id="poRefundOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-black text-uppercase">Refund Purchase Order</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="poRefundOrderId" value="@Model.Id" />
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <label class="form-label fw-black text-uppercase small">Order Ref</label>
                        <input type="text" class="form-control fw-bold bg-light" id="poRefundOrderNumber" value="@Model.OrderNumber" readonly />
                    </div>
                    <div class="col-2">
                        <label class="form-label fw-black text-uppercase small">Total</label>
                        <input type="text" class="form-control fw-bold" id="poRefundOrderTotal" value="@Model.TotalAmount.ToString("N2")" readonly />
                    </div>
                    <div class="col-2">
                        <label class="form-label fw-black text-uppercase small">Paid</label>
                        <input type="text" class="form-control fw-bold text-success" id="poRefundOrderPaid" value="0.00" readonly />
                    </div>
                    <div class="col-2">
                        <label class="form-label fw-black text-uppercase small text-danger">Recovered</label>
                        <input type="text" class="form-control fw-bold" id="poRefundOrderAlreadyRefunded" value="@Model.RefundedAmount.ToString("N2")" readonly />
                    </div>
                </div>

                <div class="mb-4" id="poRefundStockSection">
                    <h6 class="fw-black text-uppercase small mb-2 border-bottom border-2 pb-1">Product Returns (Return to Supplier)</h6>
                    <div class="table-responsive neo-card p-0 mb-2" style="max-height: 250px; overflow-y: auto;">
                        <table class="table table-sm mb-0 align-middle">
                            <thead class="table-dark text-white sticky-top">
                                <tr>
                                    <th>PRODUCT</th>
                                    <th class="text-center">RECEIVED</th>
                                    <th class="text-center">PREV. RET.</th>
                                    <th class="text-center" style="width: 120px;">RETURN QTY</th>
                                </tr>
                            </thead>
                            <tbody id="po-refund-lines-body"></tbody>
                        </table>
                    </div>
                    <div class="small fw-bold text-muted text-end"><i class="bi bi-info-circle me-1"></i> ENTER QUANTITIES TO RETURN TO SUPPLIER.</div>
                </div>

                <div class="mb-4 pt-3 border-top border-2" id="poRefundMoneySection">
                    <h6 class="fw-black text-uppercase small mb-2">Financial Reversal</h6>
                    <div class="row align-items-end">
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted">AMOUNT TO REFUND</label>
                            <div class="input-group">
                                <span class="input-group-text bg-black text-white">$</span>
                                <input type="number" class="form-control fw-black" id="poRefundAmount" step="0.01" value="0" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-0">
                    <label class="form-label fw-black text-uppercase small">Reason Context</label>
                    <textarea class="form-control" id="poRefundReason" rows="2" placeholder="Required for audit trail..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="neo-btn" data-bs-dismiss="modal">CANCEL</button>
                <button class="neo-btn neo-btn-danger" id="btn-execute-po-refund" onclick="processPoRefund()">EXECUTE REFUND</button>
            </div>
        </div>
    </div>
</div>

<!-- Record Payment Modal -->
<div class="modal fade" id="recordPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-4 border-black border-radius-0">
            <div class="modal-header bg-black text-white">
                <h5 class="modal-title fw-black text-uppercase small">Record New Payment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 bg-light">
                <div class="neo-card mb-4 bg-white p-3 border-2">
                    <div class="d-flex justify-content-between mb-2 fw-bold small">
                        <span>REMAINING BALANCE:</span>
                        <span class="text-danger">@Model.RemainingAmount.ToString("C2")</span>
                    </div>
                </div>

                <form id="recordPaymentForm">
                    <div class="mb-3">
                        <label class="form-label fw-black text-uppercase small">Amount To Spend</label>
                        <div class="input-group">
                            <span class="input-group-text bg-black text-white fw-black border-0">$</span>
                            <input type="number" class="form-control fw-black fs-4" id="paymentAmount" 
                                   step="0.01" min="0.01" max="@Model.RemainingAmount" 
                                   value="@Model.RemainingAmount.ToString("0.00")">
                        </div>
                        <div class="form-text fw-bold text-muted mt-2">Maximum allowed: @Model.RemainingAmount.ToString("C2")</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-black text-uppercase small">Payment Method</label>
                        <select class="form-select fw-black" id="paymentMethod">
                            @foreach (var method in Enum.GetValues<Inventory.Domain.Entities.PaymentMethod>())
                            {
                                <option value="@((int)method)">@method.ToString().ToUpper()</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-black text-uppercase small">Reference / Check #</label>
                        <input type="text" class="form-control fw-bold" id="paymentReference" placeholder="Optional reference">
                    </div>

                    <div class="mb-0">
                        <label class="form-label fw-black text-uppercase small">Notes</label>
                        <textarea class="form-control fw-bold" id="paymentNote" rows="2" placeholder="Optional memo"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light border-0">
                <button class="neo-btn btn-sm" data-bs-dismiss="modal">CANCEL</button>
                <button class="neo-btn neo-btn-primary btn-sm px-4" id="submitPaymentBtn" onclick="submitPayment()">CONFIRM PAYMENT</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Payment Deadline Modal -->
<div class="modal fade" id="editPaymentDeadlineModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-black text-white">
                <h5 class="modal-title fw-black text-uppercase small">Update Payment Deadline</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label fw-black text-uppercase small">New Deadline</label>
                    <input type="date" class="form-control fw-bold" id="newPaymentDeadline" value="@(Model.PaymentDeadline.HasValue ? Model.PaymentDeadline.Value.ToString("yyyy-MM-dd") : "")">
                </div>
            </div>
            <div class="modal-footer border-0 pt-0 p-4">
                <button class="neo-btn btn-sm" data-bs-dismiss="modal">CANCEL</button>
                <button class="neo-btn neo-btn-primary btn-sm" onclick="savePaymentDeadline()">UPDATE</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Payment Info Modal -->
<div class="modal fade" id="editPaymentInfoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-4 border-black border-radius-0">
            <div class="modal-header bg-black text-white">
                <h5 class="modal-title fw-black text-uppercase small">Edit Payment Information</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="editPaymentInfoForm">
                    <input type="hidden" id="editOrderId" value="@Model.Id" />
                    
                    <div class="mb-3">
                        <label class="form-label fw-black text-uppercase small">Payment Method</label>
                        <select class="form-select fw-bold" id="editPaymentMethod" onchange="toggleEditPaymentFields()">
                            @foreach (var method in Enum.GetValues<Inventory.Domain.Entities.PaymentMethod>())
                            {
                                <option value="@((int)method)" selected="@(method == Model.PaymentMethod)">@method.ToString().ToUpper()</option>
                            }
                        </select>
                    </div>

                    <div id="checkFields" style="display: none;">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editCheckReceived" @(Model.CheckReceived == true ? "checked" : "")>
                                <label class="form-check-label fw-bold small">Check Issued</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-black text-uppercase small">Check Issued Date</label>
                            <input type="date" class="form-control fw-bold" id="editCheckReceivedDate" value="@(Model.CheckReceivedDate?.ToString("yyyy-MM-dd") ?? "")">
                        </div>
                        <hr class="border-2 opacity-100">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editCheckCashed" @(Model.CheckCashed == true ? "checked" : "")>
                                <label class="form-check-label fw-bold small">Check Cashed</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-black text-uppercase small">Check Cashed Date</label>
                            <input type="date" class="form-control fw-bold" id="editCheckCashedDate" value="@(Model.CheckCashedDate?.ToString("yyyy-MM-dd") ?? "")">
                        </div>
                    </div>

                    <div id="transferFields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label fw-black text-uppercase small">Transfer ID / Reference</label>
                            <input type="text" class="form-control fw-bold" id="editTransferId" value="@Model.TransferId">
                        </div>
                    </div>

                    <div class="mb-0">
                        <label class="form-label fw-black text-uppercase small">Internal Note</label>
                        <textarea class="form-control fw-bold" id="editOrderNote" rows="2">@Model.Note</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button class="neo-btn btn-sm" data-bs-dismiss="modal">CANCEL</button>
                <button class="neo-btn neo-btn-primary btn-sm px-4" id="savePaymentInfoBtn" onclick="savePaymentInfo()">SAVE CHANGES</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function escapeHtmlPo(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

        function openPoRefundModal() {
            const id = @Model.Id;
            document.getElementById('poRefundOrderId').value = id;
            document.getElementById('poRefundOrderNumber').value = '@Model.OrderNumber';
            document.getElementById('poRefundOrderTotal').value = '@Model.TotalAmount.ToString("N2")';
            document.getElementById('poRefundOrderPaid').value = '0.00'; // Will be updated by fetch
            document.getElementById('poRefundOrderAlreadyRefunded').value = '@Model.RefundedAmount.ToString("N2")';
            document.getElementById('poRefundAmount').value = '';
            document.getElementById('poRefundReason').value = '';

            const tbody = document.getElementById('po-refund-lines-body');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></td></tr>';
            new bootstrap.Modal(document.getElementById('poRefundOrderModal')).show();

            fetch(`/api/purchase-orders/${id}`)
                .then(r => r.ok ? r.json() : Promise.reject())
                .then(o => {
                    const canRefundStock = (o.status === 1 || o.status === "Received");
                    // Fix: Eligibility depends on having money to refund (Net Paid > 0), not just the status label.
                    const canRefundMoney = (o.paidAmount > 0);
                    // Max refundable money is the Net Paid amount. We cannot refund more than what we hold.
                    const remainingRefundableAmount = o.paidAmount || 0;
                    const moneyFullyRefunded = remainingRefundableAmount <= 0;

                    // Update Paid field in header (Gross Paid)
                    const grossPaid = (o.payments || [])
                        .filter(p => p.paymentType === 1) // 1 = Payment
                        .reduce((sum, p) => sum + p.amount, 0);
                    document.getElementById('poRefundOrderPaid').value = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2 }).format(grossPaid);

                    document.getElementById('poRefundMoneySection').style.display = (!canRefundMoney || moneyFullyRefunded) ? 'none' : 'block';
                    document.getElementById('poRefundStockSection').style.display = !canRefundStock ? 'none' : 'block';

                    const amountInput = document.getElementById('poRefundAmount');
                    if (!canRefundMoney || moneyFullyRefunded) {
                        amountInput.disabled = true;
                        amountInput.placeholder = moneyFullyRefunded ? 'Fully refunded' : 'Payment not completed';
                    } else {
                        amountInput.disabled = false;
                        amountInput.placeholder = 'Max: ' + new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(remainingRefundableAmount);
                        amountInput.max = remainingRefundableAmount;
                    }

                    tbody.innerHTML = (o.lines || []).map(l => {
                        const remaining = l.quantity - (l.refundedQuantity || 0);
                        const lineFullyRefunded = remaining <= 0;
                        const disabled = (!canRefundStock || lineFullyRefunded) ? 'disabled' : '';
                        const hint = lineFullyRefunded ? 'Fully returned' : (!canRefundStock ? 'Order not received' : '');
                        return `<tr>
                            <td><div class="fw-black small text-uppercase">${escapeHtmlPo(l.productName)}</div><div class="small text-muted">${l.batchNumber ? '<code>' + escapeHtmlPo(l.batchNumber) + '</code>' : 'NO BATCH'}</div></td>
                            <td class="text-center fw-bold">${l.quantity}</td>
                            <td class="text-center text-muted">${l.refundedQuantity || 0}</td>
                            <td class="text-center"><input type="number" class="form-control form-control-sm fw-black text-center po-refund-line-qty" data-line-id="${l.id}" data-batch-number="${l.batchNumber || ''}" min="0" max="${remaining}" value="" ${disabled} placeholder="${hint}" title="${hint}" style="border: 2px solid #000;"></td>
                        </tr>`;
                    }).join('');

                    document.querySelectorAll('.po-refund-line-qty').forEach(input => { input.oninput = validatePoRefundForm; });
                    document.getElementById('poRefundAmount').oninput = validatePoRefundForm;
                    validatePoRefundForm();
                })
                .catch(() => { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger fw-bold">FAILED TO LOAD LINES</td></tr>'; });
        }

        function validatePoRefundForm() {
            let amt = parseFloat(document.getElementById('poRefundAmount').value) || 0;
            let hasLines = false;
            document.querySelectorAll('.po-refund-line-qty').forEach(input => { if ((parseFloat(input.value) || 0) > 0) hasLines = true; });
            const btn = document.getElementById('btn-execute-po-refund');
            if (btn) btn.disabled = !(amt > 0 || hasLines);
        }

        async function processPoRefund() {
            const id = parseInt(document.getElementById('poRefundOrderId').value);
            const amt = parseFloat(document.getElementById('poRefundAmount').value) || 0;
            const rsn = document.getElementById('poRefundReason').value;

            const lines = [];
            document.querySelectorAll('.po-refund-line-qty').forEach(input => {
                const qty = parseFloat(input.value) || 0;
                if (qty > 0) {
                    const item = { purchaseOrderLineId: parseInt(input.dataset.lineId), quantity: qty };
                    if (input.dataset.batchNumber) item.batchNumber = input.dataset.batchNumber;
                    lines.push(item);
                }
            });

            if (amt <= 0 && lines.length === 0) { if (window.appMessages) window.appMessages.showError('Please specify a refund amount, returned products, or both.'); return; }

            const payload = { orderId: id };
            if (amt > 0) payload.amount = amt;
            if (lines.length > 0) payload.lineItems = lines;
            if (rsn && rsn.trim()) payload.reason = rsn.trim();

            try {
                const r = await fetch(`/api/purchase-orders/${id}/refund`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value },
                    body: JSON.stringify(payload)
                });
                if (!r.ok) {
                    const errText = await r.text();
                    const msg = window.appMessages ? await window.appMessages.getApiErrorMessage(r, errText) : errText;
                    throw new Error(msg);
                }
                bootstrap.Modal.getInstance(document.getElementById('poRefundOrderModal')).hide();
                if (window.appMessages) window.appMessages.showSuccess('Refund processed successfully.');
                location.reload();
            } catch (e) { if (window.appMessages) window.appMessages.showError(e.message || 'Refund failed'); }
        }

        function openEditPaymentDeadlineModal() {
            new bootstrap.Modal(document.getElementById('editPaymentDeadlineModal')).show();
        }

        function openRecordPaymentModal() {
            new bootstrap.Modal(document.getElementById('recordPaymentModal')).show();
        }

        function openEditPaymentInfoModal() {
            toggleEditPaymentFields();
            new bootstrap.Modal(document.getElementById('editPaymentInfoModal')).show();
        }

        function toggleEditPaymentFields() {
            const method = document.getElementById('editPaymentMethod').value;
            document.getElementById('checkFields').style.display = (method === '2') ? 'block' : 'none'; // 2 = Check
            document.getElementById('transferFields').style.display = (method === '3') ? 'block' : 'none'; // 3 = BankTransfer
        }

        async function savePaymentInfo() {
            const btn = document.getElementById('savePaymentInfoBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>SAVING...';

            const payload = {
                orderId: parseInt(document.getElementById('editOrderId').value),
                paymentMethod: parseInt(document.getElementById('editPaymentMethod').value),
                checkReceived: document.getElementById('editCheckReceived').checked,
                checkReceivedDate: document.getElementById('editCheckReceivedDate').value || null,
                checkCashed: document.getElementById('editCheckCashed').checked,
                checkCashedDate: document.getElementById('editCheckCashedDate').value || null,
                transferId: document.getElementById('editTransferId').value,
                note: document.getElementById('editOrderNote').value
            };

            try {
                const response = await fetch('/api/purchase-orders/@Model.Id/payment-info', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const errText = await response.text();
                    const msg = window.appMessages ? await window.appMessages.getApiErrorMessage(response, errText) : errText;
                    if (window.appMessages) window.appMessages.showError(msg);
                    btn.disabled = false;
                    btn.innerText = 'SAVE CHANGES';
                }
            } catch (error) {
                console.error(error);
                if (window.appMessages) window.appMessages.showError(error.message || 'An error occurred.');
                btn.disabled = false;
                btn.innerText = 'SAVE CHANGES';
            }
        }

        async function submitPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            if (isNaN(amount) || amount <= 0) {
                if (window.appMessages) window.appMessages.showError('Please enter a valid amount.');
                return;
            }

            if (amount > @Model.RemainingAmount) {
                if (window.appMessages) window.appMessages.showError('Amount exceeds remaining balance.');
                return;
            }

            const btn = document.getElementById('submitPaymentBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>PROCESSING...';

            const payload = {
                amount: amount,
                paymentDate: new Date().toISOString(),
                paymentMethod: document.getElementById('paymentMethod').value,
                reference: document.getElementById('paymentReference').value,
                note: document.getElementById('paymentNote').value
            };

            try {
                const response = await fetch('/api/purchase-orders/@Model.Id/payments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const errText = await response.text();
                    const msg = window.appMessages ? await window.appMessages.getApiErrorMessage(response, errText) : errText;
                    if (window.appMessages) window.appMessages.showError(msg);
                    btn.disabled = false;
                    btn.innerText = 'CONFIRM PAYMENT';
                }
            } catch (error) {
                console.error(error);
                if (window.appMessages) window.appMessages.showError(error.message || 'An error occurred.');
                btn.disabled = false;
                btn.innerText = 'CONFIRM PAYMENT';
            }
        }

        async function savePaymentDeadline() {
            const date = document.getElementById('newPaymentDeadline').value;
            let payload = null;
            if (date) {
                payload = new Date(date).toISOString();
            }

            try {
                const response = await fetch('/api/purchase-orders/@Model.Id/payment-deadline', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(payload) 
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const errText = await response.text();
                    const msg = window.appMessages ? await window.appMessages.getApiErrorMessage(response, errText) : 'Failed to update payment deadline.';
                    if (window.appMessages) window.appMessages.showError(msg);
                }
            } catch (error) {
                console.error(error);
                if (window.appMessages) window.appMessages.showError(error.message || 'An error occurred.');
            }
        }
    </script>
}
