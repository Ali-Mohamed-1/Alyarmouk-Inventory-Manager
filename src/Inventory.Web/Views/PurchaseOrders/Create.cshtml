@model Inventory.Application.DTOs.PurchaseOrder.CreatePurchaseOrderRequest
@{
    ViewData["Title"] = "Create Purchase Order";
    var suppliers = ViewBag.Suppliers as IEnumerable<Inventory.Application.DTOs.Supplier.SupplierResponse> ?? new List<Inventory.Application.DTOs.Supplier.SupplierResponse>();
    var products = ViewBag.Products as IEnumerable<Inventory.Application.DTOs.Product.ProductResponseDto> ?? new List<Inventory.Application.DTOs.Product.ProductResponseDto>();
}

<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <a asp-controller="Dashboard" asp-action="Index" class="text-decoration-none text-muted small fw-bold mb-2 d-block">
                <i class="bi bi-arrow-left me-1"></i> BACK
            </a>
            <h1 class="display-4 fw-black text-uppercase mb-0" style="letter-spacing: -2px;">Receive <span class="text-primary">Stock</span></h1>
        </div>
    </div>

    <form asp-action="Create" method="post">
        @Html.AntiForgeryToken()
        <div class="row g-5">
            <div class="col-lg-3">
                <div class="neo-card p-0 overflow-hidden mb-4">
                    <div class="p-3 bg-black text-white">
                        <h5 class="mb-0 fw-black text-uppercase small">Supplier & Terms</h5>
                    </div>
                    <div class="p-4 bg-white">
                        <div class="mb-4">
                            <label asp-for="SupplierId" class="form-label fw-black text-uppercase small">Supplier</label>
                            <select asp-for="SupplierId" class="form-select fw-bold" required>
                                <option value="">-- SELECT SUPPLIER --</option>
                                @foreach (var s in suppliers)
                                {
                                    <option value="@s.Id">@s.Name.ToUpper()</option>
                                }
                            </select>
                            <span asp-validation-for="SupplierId" class="text-danger small fw-bold"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="DueDate" class="form-label fw-black text-uppercase small">Payment Deadline</label>
                            <input asp-for="DueDate" type="date" class="form-control fw-bold" value="@DateTime.Today.AddDays(7).ToString("yyyy-MM-dd")" />
                            <span asp-validation-for="DueDate" class="text-danger small fw-bold"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="ReceiptExpenses" class="form-label fw-black text-uppercase small">Receipt / Shipping Expenses</label>
                            <div class="input-group">
                                <span class="input-group-text bg-black text-white">$</span>
                                <input asp-for="ReceiptExpenses" type="number" step="0.01" class="form-control fw-bold" value="0.00" />
                            </div>
                        </div>

                        <div class="mb-0">
                            <label asp-for="Note" class="form-label fw-black text-uppercase small">Internal Notes</label>
                            <textarea asp-for="Note" class="form-control fw-bold" rows="3" placeholder="Context for this receipt..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="neo-card p-0 overflow-hidden mb-4" style="background: var(--neo-yellow);">
                    <div class="p-3 bg-black text-white">
                        <h5 class="mb-0 fw-black text-uppercase small">Tax & Payment</h5>
                    </div>
                    <div class="p-4 bg-dark">
                        <div class="mb-4">
                            <label asp-for="PaymentMethod" class="form-label fw-black text-uppercase small text-white">Payment Method</label>
                            <select asp-for="PaymentMethod" class="form-select fw-black">
                                <option value="1">CASH</option>
                                <option value="2">CHECK</option>
                                <option value="3">BANK TRANSFER</option>
                            </select>
                        </div>

                        <div class="neo-card p-3 bg-white mb-0 border-2">
                            <div class="form-check mb-3">
                                <input asp-for="ApplyVat" class="form-check-input" type="checkbox" checked>
                                <label class="form-check-label fw-black text-uppercase small ms-2" asp-for="ApplyVat">Apply VAT (14%)</label>
                            </div>
                            <div class="form-check mb-0">
                                <input asp-for="ApplyManufacturingTax" class="form-check-input" type="checkbox" checked>
                                <label class="form-check-label fw-black text-uppercase small ms-2" asp-for="ApplyManufacturingTax">Apply MAN. Tax (1%)</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <div class="neo-card p-0 overflow-hidden h-100 d-flex flex-column">
                    <div class="p-3 bg-black text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-black text-uppercase small">Line Items (Incoming Stock)</h5>
                        <button type="button" class="neo-btn neo-btn-success btn-sm" onclick="addPoLineItem()">
                            <i class="bi bi-plus-lg"></i> ADD ITEM
                        </button>
                    </div>
                    <div class="p-0 flex-grow-1 bg-white">
                        <div class="table-responsive" style="min-height: 260px;">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-dark text-white small text-uppercase fw-black">
                                    <tr>
                                        <th class="ps-4">PRODUCT</th>
                                        <th>BATCH / LOT</th>
                                        <th style="width: 15%">QTY</th>
                                        <th style="width: 15%">UNIT COST</th>
                                        <th class="text-end pe-4" style="width: 5%;">TRASH</th>
                                    </tr>
                                </thead>
                                <tbody id="po-line-items-container">
                                </tbody>
                            </table>
                        </div>
                        <div id="po-empty-state" class="text-center py-5">
                            <i class="bi bi-box-arrow-in-down text-muted" style="font-size: 4rem; opacity: 0.2;"></i>
                            <p class="fw-black text-muted mt-3">NO LINES ADDED YET.</p>
                            <button type="button" class="neo-btn" onclick="addPoLineItem()">ADD FIRST ITEM</button>
                        </div>
                    </div>
                    <div class="p-4 border-top border-4 bg-white">
                        <div class="row g-4 align-items-end">
                            <div class="col-md-5">
                                <div class="neo-card p-3 bg-light mb-0 border-2">
                                    <p class="small text-muted mb-0 fw-bold">
                                        Financial totals (including taxes and receipt expenses) are finalized on the server.
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <button type="submit" class="neo-btn neo-btn-primary w-100 py-3 fw-black fs-5">
                                    <i class="bi bi-download me-2"></i> RECEIVE STOCK
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <style>
        /* Hide number input arrows/spinners */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>

    <script>
        let poLineIndex = 0;
        const poProducts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(products.Select(p => new { p.Id, p.Name, p.Sku, p.Unit })));

        // Global click handler to close dropdowns
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.searchable-dropdown')) {
                document.querySelectorAll('.searchable-dropdown .dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        async function fetchBatches(productId) {
            try {
                const response = await fetch(`/api/products/${productId}/batches`);
                const allBatches = await response.json();
                return allBatches;
            } catch (error) {
                console.error('Error loading batches:', error);
                return [];
            }
        }

        // Custom Dropdown Helper
        function setupDropdown(input, list, items, onSelect, itemRenderer, allowCustom = false) {
            const show = () => {
                // Close others
                document.querySelectorAll('.searchable-dropdown .dropdown-menu.show').forEach(m => m !== list && m.classList.remove('show'));

                list.innerHTML = '';
                const filter = input.value.toLowerCase();
                const filtered = items.filter(i => itemRenderer(i).text.toLowerCase().includes(filter));

                if (filtered.length === 0) {
                     if (!allowCustom) {
                        list.innerHTML = '<li class="dropdown-item text-muted small">No matches found</li>';
                     }
                } else {
                    filtered.forEach(item => {
                        const rendered = itemRenderer(item);
                        const li = document.createElement('li');
                        li.className = 'dropdown-item small py-2 border-bottom';
                        li.style.cursor = 'pointer';
                        li.style.whiteSpace = 'normal';
                        li.innerHTML = rendered.html;
                        li.onclick = () => {
                            input.value = rendered.text;
                            onSelect(item);
                            list.classList.remove('show');
                        };
                        list.appendChild(li);
                    });
                }
                
                if (filtered.length > 0 || !allowCustom) {
                    list.classList.add('show');
                } else {
                    list.classList.remove('show');
                }
            };

            input.addEventListener('focus', show);
            input.addEventListener('input', show);
            
            if (allowCustom) {
                 input.addEventListener('change', () => {
                     // If the current value doesn't match any item, it's a custom value
                     // We don't trigger onSelect in that case, or we trigger it with null
                     // For PO batches, typing a new batch is valid, but we don't load cost.
                 });
            }
        }

        function addPoLineItem() {
            const container = document.getElementById('po-line-items-container');
            document.getElementById('po-empty-state').style.display = 'none';

            const idx = poLineIndex++;
            const row = document.createElement('tr');
            row.id = `po-line-row-${idx}`;
            row.innerHTML = `
                <td class="ps-4 align-top">
                     <div class="searchable-dropdown position-relative" id="product-dropdown-${idx}">
                        <input type="text" class="form-control fw-black text-uppercase" placeholder="SEARCH PRODUCT..." id="product-search-${idx}" autocomplete="off" required>
                        <input type="hidden" name="Lines[${idx}].ProductId" id="product-id-input-${idx}">
                        <ul class="dropdown-menu w-100 shadow-lg border-0 rounded-0" id="product-list-${idx}" style="max-height: 300px; overflow-y: auto;"></ul>
                    </div>
                </td>
                <td class="align-top">
                    <div class="searchable-dropdown position-relative" id="batch-dropdown-${idx}">
                        <input type="text" name="Lines[${idx}].BatchNumber" class="form-control fw-bold small" placeholder="New or Existing Batch" id="batch-search-${idx}" disabled autocomplete="off">
                        <ul class="dropdown-menu w-100 shadow-lg border-0 rounded-0" id="batch-list-${idx}" style="max-height: 300px; overflow-y: auto;"></ul>
                    </div>
                </td>
                <td class="align-top">
                    <input name="Lines[${idx}].Quantity" type="number" step="0.01" min="0.0001" class="form-control fw-black text-center" value="1.00" required>
                </td>
                <td class="align-top">
                    <div class="input-group">
                        <span class="input-group-text bg-black text-white">$</span>
                        <input name="Lines[${idx}].UnitPrice" id="price-input-${idx}" type="number" step="0.01" min="0" class="form-control fw-black text-center" value="0.00" required>
                    </div>
                </td>
                <td class="text-end pe-4 align-top">
                    <button type="button" class="neo-btn neo-btn-danger btn-sm py-1" onclick="removePoLineItem(${idx})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            container.appendChild(row);

            // Bind Product Dropdown
            const pInput = document.getElementById(`product-search-${idx}`);
            const pList = document.getElementById(`product-list-${idx}`);

            setupDropdown(pInput, pList, poProducts, async (product) => {
                // On Product Select
                document.getElementById(`product-id-input-${idx}`).value = product.Id;
                // document.getElementById(`product-name-input-${idx}`).value = product.Name; // Not needed for PO create post
                document.getElementById(`price-input-${idx}`).value = "";

                // Reset Batch
                const bInput = document.getElementById(`batch-search-${idx}`);
                const bList = document.getElementById(`batch-list-${idx}`);
                bInput.value = '';
                bInput.disabled = true;
                
                // Load Batches
                const batches = await fetchBatches(product.Id);
                
                bInput.disabled = false;
                bInput.placeholder = "Select or Type Batch...";
                
                if (batches.length > 0) {
                     setupDropdown(bInput, bList, batches, (batch) => {
                        // On Batch Select
                        // Auto-load Cost
                        const cost = batch.unitCost ?? batch.UnitCost ?? 0;
                        document.getElementById(`price-input-${idx}`).value = cost.toFixed(2);
                    }, (batch) => {
                        // Batch Renderer
                         const onHand = batch.onHand ?? batch.OnHand ?? 0;
                         const cost = batch.unitCost ?? batch.UnitCost ?? 0;
                         return {
                            text: batch.batchNumber ?? batch.BatchNumber,
                            html: `
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">${batch.batchNumber ?? batch.BatchNumber}</span>
                                    <span class="badge bg-light text-dark border">Qty: ${onHand}</span>
                                </div>
                                <div class="small text-muted">Cost: $${cost.toFixed(2)}</div>
                            `
                        };
                    }, true); // Allow custom values
                }

            }, (product) => {
                 // Product Renderer
                 return {
                    text: product.Name.toUpperCase(),
                    html: `
                        <div class="fw-bold">${product.Name.toUpperCase()}</div>
                         <div class="small text-muted">SKU: ${product.Sku || 'N/A'}</div>
                    `
                };
            });
        }

        function removePoLineItem(idx) {
            const row = document.getElementById(`po-line-row-${idx}`);
            if (row) row.remove();
            if (document.querySelectorAll('#po-line-items-container tr').length === 0) {
                document.getElementById('po-empty-state').style.display = 'block';
            }
        }
    </script>
}

